<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EcoPackAI Dashboard</title>
<style>
* { box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
body { 
    margin: 0; 
    background: linear-gradient(135deg, #0a1428 0%, #1a237e 50%, #000000 100%); 
    min-height: 100vh; 
    color: #ffffff;
}
.wrapper { display: flex; height: 100vh; }
.sidebar { 
    width: 230px; 
    background: linear-gradient(180deg, #0a1428 0%, #1a237e 100%); 
    color: #f5d142; 
    padding: 20px; 
    box-shadow: 4px 0 25px rgba(245,209,66,0.3);
}
.sidebar h2 { 
    text-align: center; 
    margin-bottom: 30px; 
    background: linear-gradient(45deg, #f5d142, #ffd54f); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    background-clip: text;
    text-shadow: 0 2px 8px rgba(245,209,66,0.5);
}
.sidebar a { 
    display: block; 
    color: #ffffff; 
    padding: 12px; 
    text-decoration: none; 
    border-radius: 12px; 
    margin-bottom: 8px; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    font-weight: 500;
    border: 1px solid rgba(245,209,66,0.2);
}
.sidebar a:hover, .sidebar a.active { 
    background: linear-gradient(45deg, #f5d142, #ffd54f); 
    color: #0a1428; 
    transform: translateX(8px); 
    box-shadow: 0 6px 20px rgba(245,209,66,0.4);
    text-shadow: none;
}
.main { flex: 1; padding: 20px; overflow-y: auto; }
.topbar { 
    background: rgba(255,255,255,0.08); 
    backdrop-filter: blur(20px); 
    padding: 15px 25px; 
    border-radius: 20px; 
    display: flex; 
    justify-content: space-between; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
    border: 1px solid rgba(245,209,66,0.2);
}
.topbar h3 { 
    margin: 0; 
    background: linear-gradient(45deg, #f5d142, #ffd54f); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    background-clip: text; 
    font-weight: 700;
}
#userInfo { color: #f5d142; font-weight: 600; }
.cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 25px; }
.card { 
    background: rgba(255,255,255,0.1); 
    backdrop-filter: blur(15px); 
    padding: 25px; 
    border-radius: 20px; 
    box-shadow: 0 15px 35px rgba(0,0,0,0.4); 
    border: 1px solid rgba(245,209,66,0.2); 
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #f5d142, #ffd54f, #f5d142);
}
.card:hover { 
    transform: translateY(-8px); 
    box-shadow: 0 25px 50px rgba(245,209,66,0.2);
    border-color: rgba(245,209,66,0.4);
}
.card h4 { 
    color: rgba(255,255,255,0.8); 
    margin-bottom: 10px; 
    font-weight: 600; 
}
.card p { 
    font-size: 28px; 
    font-weight: bold; 
    background: linear-gradient(45deg, #f5d142, #ffd54f); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    background-clip: text;
}
.form-box { 
    background: rgba(255,255,255,0.1); 
    margin-top: 25px; 
    padding: 30px; 
    border-radius: 20px; 
    box-shadow: 0 15px 40px rgba(0,0,0,0.4); 
    border: 1px solid rgba(245,209,66,0.2); 
    backdrop-filter: blur(15px);
}
select, input { 
    width: 100%; 
    padding: 15px; 
    margin: 12px 0; 
    border-radius: 12px; 
    border: 2px solid rgba(245,209,66,0.3); 
    transition: all 0.3s ease; 
    background: rgba(255,255,255,0.1);
    color: #ffffff;
    backdrop-filter: blur(10px);
}
select option { background: #1a237e; color: #ffffff; }
select:focus, input:focus { 
    outline: none; 
    border-color: #f5d142; 
    box-shadow: 0 0 0 4px rgba(245,209,66,0.2); 
    transform: scale(1.02);
    background: rgba(255,255,255,0.15);
}
input::placeholder { color: rgba(255,255,255,0.6); }
input.error { 
    border-color: #ff6b6b !important; 
    box-shadow: 0 0 10px rgba(255,107,107,0.4) !important; 
}
button { 
    padding: 15px; 
    width: 100%; 
    background: linear-gradient(45deg, #f5d142, #ffd54f); 
    color: #0a1428; 
    border: none; 
    border-radius: 12px; 
    font-size: 16px; 
    font-weight: 700; 
    cursor: pointer; 
    margin: 8px 0; 
    transition: all 0.3s ease; 
    box-shadow: 0 8px 25px rgba(245,209,66,0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
}
button:hover:not(:disabled) { 
    transform: translateY(-3px); 
    box-shadow: 0 15px 35px rgba(245,209,66,0.6); 
}
button:disabled { 
    background: rgba(245,209,66,0.3); 
    cursor: not-allowed; 
    box-shadow: none; 
    transform: none; 
    color: rgba(10,20,40,0.7);
}
table { 
    width: 100%; 
    margin-top: 20px; 
    border-collapse: collapse; 
    border-radius: 12px; 
    overflow: hidden; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
th { 
    background: linear-gradient(45deg, #1a237e, #0a1428); 
    color: #f5d142; 
    padding: 15px; 
    font-weight: 700; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
}
td { 
    padding: 15px; 
    background: rgba(255,255,255,0.05); 
    text-align: center; 
    border-bottom: 1px solid rgba(245,209,66,0.1); 
    color: #ffffff;
    transition: all 0.3s ease;
}
td:hover { 
    background: rgba(245,209,66,0.1); 
    color: #f5d142;
}
.loading, .success, .error { 
    padding: 15px; 
    border-radius: 12px; 
    margin: 15px 0; 
    display: none; 
    text-align: center; 
    font-weight: 600; 
}
.loading { 
    background: linear-gradient(45deg, rgba(245,209,66,0.2), rgba(255,235,107,0.2)); 
    color: #f5d142; 
    box-shadow: 0 5px 20px rgba(245,209,66,0.3); 
    border: 1px solid rgba(245,209,66,0.4);
}
.success { 
    background: linear-gradient(45deg, #f5d142, #ffd54f); 
    color: #0a1428; 
    box-shadow: 0 5px 20px rgba(245,209,66,0.5); 
}
.error { 
    background: linear-gradient(45deg, rgba(255,107,107,0.3), rgba(255,138,128,0.3)); 
    color: #ffffff; 
    box-shadow: 0 5px 20px rgba(255,107,107,0.4); 
}
.auth { 
    max-width: 420px; 
    margin: 80px auto; 
    background: rgba(255,255,255,0.08); 
    padding: 40px; 
    border-radius: 25px; 
    box-shadow: 0 25px 60px rgba(0,0,0,0.6); 
    text-align: center; 
    backdrop-filter: blur(20px); 
    border: 1px solid rgba(245,209,66,0.3);
}
.hidden { display: none; }
label { 
    display: block; 
    margin-top: 18px; 
    font-weight: 700; 
    color: #f5d142;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
}
#debugInfo { 
    background: rgba(0,0,0,0.7); 
    padding: 15px; 
    margin: 15px 0; 
    font-family: monospace; 
    font-size: 13px; 
    border-radius: 10px; 
    border-left: 4px solid #f5d142; 
    color: #ffffff;
}
.content-section { display: none; }
.content-section.active { display: block; }
@keyframes glow { 
    0%, 100% { box-shadow: 0 0 20px rgba(245,209,66,0.5); } 
    50% { box-shadow: 0 0 40px rgba(245,209,66,0.8); } 
}
button:focus { animation: glow 1s infinite; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
::-webkit-scrollbar-thumb { background: linear-gradient(#f5d142, #ffd54f); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: linear-gradient(#ffd54f, #ffecb3); }
</style>
</head>
<body>

<!-- DEBUG INFO -->
<div style="background: linear-gradient(45deg, #1a237e, #0a1428); color: #f5d142; padding: 15px; text-align: center; box-shadow: 0 4px 20px rgba(26,35,126,0.5); border-bottom: 3px solid #f5d142;">
    <strong>üöÄ Backend Status: <span id="backendStatus" style="color: #ffffff;">Checking...</span></strong>
</div>

<!-- LOGIN & SIGNUP -->
<div class="auth" id="authBox">
    <h2 style="background: linear-gradient(45deg, #f5d142, #ffd54f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.5em; margin-bottom: 25px; font-weight: 800;">üå± EcoPackAI</h2>
    <div id="debugInfo" style="display: none;"></div>
    <div id="loginForm">
        <input id="loginEmail" placeholder="üë§ Username" required>
        <input id="loginPassword" type="password" placeholder="üîí Password" required>
        <button onclick="login()">üöÄ Login</button>
        <p style="margin: 20px 0 0 0; font-size: 14px; color: rgba(255,255,255,0.8);">Don't have account? <a href="#" onclick="showSignup()" style="color: #f5d142; font-weight: 700;">Sign Up</a></p>
    </div>
    <div id="signupForm" class="hidden">
        <input id="signupUsername" placeholder="üë§ Username" required>
        <input id="signupPassword" type="password" placeholder="üîí Password (min 3 chars)" required>
        <button onclick="signup()">‚ú® Create Account</button>
        <p style="margin: 20px 0 0 0; font-size: 14px;"><a href="#" onclick="showLogin()" style="color: #f5d142; font-weight: 700;">Back to Login</a></p>
    </div>
    <div id="errorMsg" class="error"></div>
    <div id="successMsg" class="success"></div>
</div>

<!-- DASHBOARD -->
<div class="wrapper hidden" id="dashboard">
    <div class="sidebar">
        <h2>EcoPackAI</h2>
        <a href="#" onclick="showSection('predict')" class="active">üì¶ Predict</a>
        <a href="#" onclick="showHistory()">üìà History</a>
        <a href="#" onclick="logout()">üö™ Logout</a>
    </div>
    <div class="main">
        <div class="topbar">
            <h3 id="pageTitle">Eco-Friendly Packaging Dashboard</h3>
            <span id="userInfo">üë§ Guest</span>
        </div>

        <!-- Prediction Section -->
        <div id="predictSection" class="content-section active">
            <div class="cards">
                <div class="card"><h4>Total Options</h4><p id="totalRecs">-</p></div>
                <div class="card"><h4>Best CO‚ÇÇ Score</h4><p id="avgCO2">-</p></div>
                <div class="card"><h4>ü•á Top Package</h4><p id="bestPack">-</p></div>
                <div class="card"><h4>Lowest Cost</h4><p id="ecoScore">-</p></div>
            </div>
            <div class="form-box">
                <h3 style="color: #f5d142; font-weight: 700;">üì¶ Get Packaging Recommendations</h3>
                <label>Toy Material:</label>
                <select id="toyMaterial">
                    <option value="Plastic">Plastic</option>
                    <option value="Wood">Wood</option>
                    <option value="ABS Plastic">ABS Plastic</option>
                    <option value="Fabric">Fabric</option>
                    <option value="Metal">Metal</option>
                    <option value="Cardboard">Cardboard</option>
                </select>
                <input type="number" id="weight" placeholder="Toy Weight (grams)" min="1" max="5000" step="10" value="500">
                <input type="number" id="cost" placeholder="Expected Cost (‚Çπ)" min="1" max="2000" step="10" value="50">
                <button id="predictBtn" onclick="predict()">üîÆ Get Recommendations</button>
                <div id="loadingMsg" class="loading">üîÑ AI is analyzing packaging options...</div>
                <table id="resultTable"></table>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="content-section">
            <div class="form-box">
                <h3 style="color: #f5d142; font-weight: 700;">üìà Prediction History (Last 50)</h3>
                <div id="historyLoading" class="loading" style="display: none;">Loading history...</div>
                <table id="historyTable" style="display: none;">
                    <thead>
                        <tr><th>User</th><th>Toy Material</th><th>Weight</th><th>Cost</th><th>ü•á Recommended</th><th>CO‚ÇÇ</th><th>‚Çπ Cost</th><th>Date</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const API_URLS = [
    'http://127.0.0.1:5000/api',
    'http://localhost:5000/api',
    'http://0.0.0.0:5000/api'
];
let currentApiUrl = API_URLS[0];
let isLoggedIn = false;
let currentUser = 'Guest';
let currentUserId = null;

async function testBackendConnection() {
    const debugEl = document.getElementById('debugInfo');
    const statusEl = document.getElementById('backendStatus');
    
    for (let url of API_URLS) {
        try {
            const response = await fetch(`${url.replace('/api', '')}/api/health`, { 
                method: 'GET',
                mode: 'cors'
            });
            if (response.ok) {
                const data = await response.json();
                statusEl.textContent = `‚úÖ CONNECTED (${url}) - PostgreSQL Ready`;
                statusEl.style.color = '#f5d142';
                currentApiUrl = url;
                if (debugEl) debugEl.style.display = 'none';
                return true;
            }
        } catch (e) {
            console.log(`Failed ${url}:`, e);
        }
    }
    
    statusEl.textContent = '‚ùå OFFLINE - Start: python app.py';
    statusEl.style.color = '#ff6b6b';
    if (debugEl) {
        debugEl.innerHTML = `
            <strong>üö® BACKEND NOT RUNNING</strong><br>
            1. Terminal: <code>python app.py</code><br>
            2. Wait for: <code>http://127.0.0.1:5000</code><br>
            3. Test: <a href="http://127.0.0.1:5000/api/health" target="_blank" style="color: #f5d142;">Health Check</a>
        `;
        debugEl.style.display = 'block';
    }
    return false;
}

function showMessage(msg, type) {
    const msgEl = document.getElementById(`${type}Msg`);
    if (msgEl) {
        msgEl.textContent = msg;
        msgEl.style.display = 'block';
        setTimeout(() => msgEl.style.display = 'none', 5000);
    }
}

function setFieldError(field, show = true) {
    if (show) field.classList.add('error');
    else field.classList.remove('error');
}

function clearFieldErrors() {
    document.querySelectorAll('input').forEach(field => setFieldError(field, false));
}

function showSection(section) {
    document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));
    document.getElementById(`${section}Section`).classList.add('active');
    event.target.classList.add('active');
    document.getElementById('pageTitle').textContent = 
        section === 'predict' ? 'Eco-Friendly Packaging Dashboard' :
        section === 'history' ? 'Prediction History' : 'User Management';
}

function showSignup() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('signupForm').classList.remove('hidden');
    clearFieldErrors();
}

function showLogin() {
    document.getElementById('signupForm').classList.add('hidden');
    document.getElementById('loginForm').classList.remove('hidden');
    clearFieldErrors();
}

async function signup() {
    if (!await testBackendConnection()) return;
    
    const usernameField = document.getElementById('signupUsername');
    const passwordField = document.getElementById('signupPassword');
    const username = usernameField.value.trim();
    const password = passwordField.value;

    clearFieldErrors();
    if (!username || !password || password.length < 3) {
        if (!username) setFieldError(usernameField, true);
        if (!password || password.length < 3) setFieldError(passwordField, true);
        showMessage('‚ùå Username & password (3+ chars) required', 'error');
        return;
    }

    const btn = document.querySelector('#signupForm button');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const response = await fetch(`${currentApiUrl}/signup`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showMessage('‚úÖ Account created! Please login.', 'success');
            showLogin();
            usernameField.value = passwordField.value = '';
        } else {
            showMessage(data.error || 'Signup failed', 'error');
            setFieldError(usernameField, true);
        }
    } catch (err) {
        showMessage('‚ùå Backend connection failed', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
    }
}

async function login() {
    if (!await testBackendConnection()) return;
    
    const usernameField = document.getElementById('loginEmail');
    const passwordField = document.getElementById('loginPassword');
    const username = usernameField.value.trim();
    const password = passwordField.value;

    clearFieldErrors();
    if (!username || !password) {
        if (!username) setFieldError(usernameField, true);
        if (!password) setFieldError(passwordField, true);
        showMessage('‚ùå Enter username & password', 'error');
        return;
    }

    const btn = document.querySelector('#loginForm button');
    btn.disabled = true;
    btn.textContent = 'Logging in...';

    try {
        const response = await fetch(`${currentApiUrl}/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        
        const data = await response.json();
        
        if (response.ok) {
            isLoggedIn = true;
            currentUser = data.username || username;
            currentUserId = data.user_id;
            document.getElementById('userInfo').textContent = `üë§ ${currentUser}`;
            document.getElementById('authBox').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            showMessage(`‚úÖ Welcome ${currentUser}!`, 'success');
        } else {
            showMessage(data.error || 'Login failed', 'error');
            setFieldError(usernameField, true);
        }
    } catch (err) {
        showMessage('‚ùå Backend connection failed', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Login';
    }
}

async function predict() {
    const toyMaterial = document.getElementById("toyMaterial").value;
    const weight = parseFloat(document.getElementById("weight").value);
    const cost = parseFloat(document.getElementById("cost").value);

    if (!weight || !cost || weight <= 0 || cost <= 0) {
        showMessage('‚ùå Enter valid weight (1-5000g) & cost (‚Çπ1-2000)', 'error');
        return;
    }

    document.getElementById('loadingMsg').style.display = 'block';
    document.getElementById('predictBtn').disabled = true;

    try {
        const response = await fetch(`${currentApiUrl}/predict`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                toy_weight: weight,
                toy_cost: cost,
                toy_material: toyMaterial,
                username: currentUser,
                user_id: currentUserId
            })
        });

        const data = await response.json();
        if (response.ok) {
            displayResults(data);
            showMessage(`‚úÖ Saved to history: ${data.recommended_packaging}`, 'success');
        } else {
            showMessage(data.error || 'Prediction failed', 'error');
        }
    } catch (err) {
        showMessage('‚ùå Prediction failed - check backend', 'error');
    } finally {
        document.getElementById('loadingMsg').style.display = 'none';
        document.getElementById('predictBtn').disabled = false;
    }
}

function displayResults(data) {
    document.getElementById('totalRecs').textContent = data.top_3?.length || 0;
    document.getElementById('avgCO2').textContent = data.co2_emission ? data.co2_emission.toFixed(2) + 'kg' : '-';
    document.getElementById('bestPack').textContent = data.recommended_packaging || '-';
    document.getElementById('ecoScore').textContent = data.packaging_cost ? '‚Çπ' + data.packaging_cost : '-';

    const table = document.getElementById('resultTable');
    let html = '<tr><th>ü•á Rank</th><th>Package</th><th>CO‚ÇÇ(kg)</th><th>Cost(‚Çπ)</th><th>Eco Score</th></tr>';
    (data.top_3 || []).forEach((pkg, i) => {
        html += `<tr>
            <td>${['ü•á','ü•à','ü•â'][i]}</td>
            <td><strong>${pkg.packaging || pkg.name || 'N/A'}</strong></td>
            <td>${(pkg.co2_emission || 0).toFixed(2)}</td>
            <td>‚Çπ${(pkg.cost || 0).toFixed(0)}</td>
            <td>${(pkg.eco_score || 0).toFixed(1)}</td>
        </tr>`;
    });
    table.innerHTML = html;
}

async function showHistory() {
    showSection('history');
    document.getElementById('historyLoading').style.display = 'block';
    document.getElementById('historyTable').style.display = 'none';
    
    try {
        const response = await fetch(`${currentApiUrl}/history`);
        const data = await response.json();
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';
        
        data.history.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${row.username}</strong></td>
                <td>${row.toy_material}</td>
                <td>${row.toy_weight}g</td>
                <td>‚Çπ${row.toy_cost}</td>
                <td><strong>${row.recommended_packaging}</strong></td>
                <td>${row.co2_emission}kg</td>
                <td>‚Çπ${row.packaging_cost}</td>
                <td>${new Date(row.created_at).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('historyTable').style.display = 'table';
    } catch(e) {
        showMessage('Error loading history', 'error');
    } finally {
        document.getElementById('historyLoading').style.display = 'none';
    }
}

function logout() {
    isLoggedIn = false;
    currentUser = 'Guest';
    currentUserId = null;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('authBox').classList.remove('hidden');
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('loginEmail').value = document.getElementById('loginPassword').value = '';
}

window.onload = () => {
    testBackendConnection();
    document.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            if (!isLoggedIn) {
                document.querySelector('#authBox button:not(:disabled)')?.click();
            } else {
                predict();
            }
        }
    });
};
</script>
</body>
</html>
