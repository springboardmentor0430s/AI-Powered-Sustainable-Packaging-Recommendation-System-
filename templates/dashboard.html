{% extends "base.html" %}

{% block title %}Dashboard - EcoPackAI{% endblock %}

{% block extra_css %}
<style>
.stat-card { transition: transform 0.3s ease; border-radius: 15px; }
.stat-card:hover { transform: translateY(-5px); }
.stat-icon {
    width: 60px; height: 60px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 12px; font-size: 24px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

<!-- Welcome Banner -->
<div class="bg-success bg-gradient py-5 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="text-white fw-bold mb-2">
                    Welcome, <span id="username">User</span>!
                </h1>
                <p class="text-white-50 mb-0">
                    AI-powered sustainable packaging insights at a glance.
                </p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light btn-lg" onclick="location.href='/product-input'">
                    <i class="fas fa-plus me-2"></i>New Recommendation
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container">

<!-- Stats -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card stat-card shadow-sm">
            <div class="card-body d-flex align-items-center">
                <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Recommendations</h6>
                    <h3 id="totalRecs">0</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card shadow-sm">
            <div class="card-body d-flex align-items-center">
                <div class="stat-icon bg-info bg-opacity-10 text-info me-3">
                    <i class="fas fa-cloud"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">CO₂ Reduced</h6>
                    <h3 id="co2Reduced">0%</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card shadow-sm">
            <div class="card-body d-flex align-items-center">
                <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Cost Saved</h6>
                    <h3 id="costSaved">0%</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card shadow-sm">
            <div class="card-body d-flex align-items-center">
                <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                    <i class="fas fa-leaf"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Eco Score</h6>
                    <h3 id="ecoScore">0</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Recommendations -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="fw-bold mb-0">
            <i class="fas fa-history me-2"></i>Recent Recommendations
        </h5>
    </div>
    <div class="card-body">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Score</th>
                    <th>CO₂ Reduction</th>
                    <th>Cost Savings</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="recentTableBody"></tbody>
        </table>

        <div id="noData" class="text-center text-muted d-none">
            No recommendations yet.
        </div>
    </div>
</div>

</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", loadDashboard);

async function loadDashboard() {
    const token = localStorage.getItem("token");
    if (!token) {
        window.location.href = "/login";
        return;
    }

    /* PROFILE */
    const profileRes = await fetch("/api/auth/profile", {
        headers: { Authorization: `Bearer ${token}` }
    });
    if (profileRes.ok) {
        const profile = await profileRes.json();
        document.getElementById("username").textContent = profile.username || "User";
    }

    /* ANALYTICS */
    const analyticsRes = await fetch("/api/analytics/dashboard", {
        headers: { Authorization: `Bearer ${token}` }
    });
    if (analyticsRes.ok) {
        const data = await analyticsRes.json();
        if (data.metrics) updateStats(data.metrics);
    }

    /* HISTORY */
    const historyRes = await fetch("/api/recommendations/history", {
        headers: { Authorization: `Bearer ${token}` }
    });
    if (historyRes.ok) {
        const data = await historyRes.json();
        renderHistory(data.recommendations || []);
    }
}

function updateStats(m) {
    document.getElementById("totalRecs").textContent = m.total_recommendations || 0;
    document.getElementById("co2Reduced").textContent = (m.total_co2_reduced || 0) + "%";
    document.getElementById("costSaved").textContent = (m.total_cost_saved || 0) + "%";
    document.getElementById("ecoScore").textContent =
        Math.round((m.avg_co2_reduction || 0) + (m.avg_cost_savings || 0));
}

function renderHistory(recs) {
    const body = document.getElementById("recentTableBody");
    const noData = document.getElementById("noData");

    if (!recs.length) {
        noData.classList.remove("d-none");
        return;
    }

    body.innerHTML = recs.slice(0, 5).map(r => `
        <tr>
            <td>${r.material_name || "N/A"}</td>
            <td>${(r.recommendation_score || 0).toFixed(2)}</td>
            <td>${r.co2_reduction_percent || 0}%</td>
            <td>${r.cost_savings_percent || 0}%</td>
            <td>${r.created_at ? new Date(r.created_at).toLocaleDateString() : "N/A"}</td>
        </tr>
    `).join("");
}
</script>
{% endblock %}
