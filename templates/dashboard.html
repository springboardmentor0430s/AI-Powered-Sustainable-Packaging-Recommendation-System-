<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>EcoPackAI - Smart Food Packaging Recommendations ðŸŒ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style> 
        :root { 
            --charcoal: #2C3E50; 
            --asparagus: #27AE60;
            --asparagus-dark: #229954;
            --burlywood: #95A5A6; 
            --melon: #E74C3C; 
            --misty-grey: #F8FAFC;
            --white: #ffffff;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
            
            /* Professional Industrial Chart Colors */
            --chart-blue: #1F77B4;
            --chart-orange: #FF7F0E;
            --chart-green: #2CA02C;
            --chart-red: #D62728;
            --chart-purple: #9467BD;
            --chart-brown: #8C564B;
            --chart-pink: #E377C2;
            --chart-gray: #7F7F7F;
            --chart-olive: #BCBD22;
            --chart-cyan: #17BECF;
            
             /* Current/Baseline color */
            --chart-current: #525252;
            
            /* Professional Stat Card Colors */
            --stat-purple: #6366F1;
            --stat-purple-dark: #4F46E5;
            --stat-blue: #0EA5E9;
            --stat-blue-dark: #0284C7;
            --stat-green: #22C55E;
            --stat-green-dark: #16A34A;
            --stat-amber: #FB923C;
            --stat-amber-dark: #F97316;
        }
         
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        } 
         
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--misty-grey); 
            color: var(--charcoal);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
        }
         
        .navbar { 
            background: var(--charcoal); 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
            padding: 0.75rem 2rem; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
         
        .navbar-brand { 
            font-size: 1.35rem; 
            font-weight: 600; 
            color: white !important; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
         
        .sidebar { 
            background: var(--white); 
            min-height: calc(100vh - 80px); 
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.08); 
            padding: 2rem 1rem; 
            position: sticky; 
            top: 80px; 
        } 
         
        .nav-pills .nav-link { 
            color: #6B7280; 
            border-radius: var(--border-radius-sm); 
            padding: 0.75rem 1rem; 
            margin-bottom: 0.5rem; 
            transition: all 0.2s ease; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            font-size: 0.95rem;
        }
         
        .nav-pills .nav-link:hover { 
            background: #F3F4F6; 
            color: var(--charcoal); 
            transform: translateX(4px); 
        }
         
        .nav-pills .nav-link.active { 
            background: var(--asparagus); 
            color: white; 
            box-shadow: none; 
        }
         
        .card { 
            border: 1px solid #E5E7EB; 
            border-radius: var(--border-radius-md); 
            background: var(--white); 
            box-shadow: var(--shadow-sm); 
            transition: box-shadow 0.2s ease; 
            overflow: hidden; 
        }
         
        .card:hover {
            box-shadow: var(--shadow-md);
            transform: none;
        }
         
        .card-header { 
            background: var(--white); 
            border-bottom: 1px solid #E5E7EB; 
            padding: 1.25rem 1.5rem; 
        }
         
        .card-header h4 { 
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #1F2937; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            margin: 0; 
        }
         
        .stat-card { 
            color: white; 
            border: none;
            border-radius: var(--border-radius-md);
        }
        
        .stat-card.recommendations { 
            background: linear-gradient(135deg, var(--stat-purple) 0%, var(--stat-purple-dark) 100%); 
        }
        
        .stat-card.cost-savings { 
            background: linear-gradient(135deg, var(--stat-blue) 0%, var(--stat-blue-dark) 100%); 
        }
        
        .stat-card.co2-impact { 
            background: linear-gradient(135deg, var(--stat-green) 0%, var(--stat-green-dark) 100%); 
        }
        
        .stat-card.sustainability { 
            background: linear-gradient(135deg, var(--stat-amber) 0%, var(--stat-amber-dark) 100%); 
        }
         
        .stat-card .card-body { 
            position: relative; 
            z-index: 1; 
            padding: 2rem; 
        } 
         
        .metric-icon { 
            font-size: 2.5rem; 
            opacity: 0.9; 
            margin-bottom: 0.5rem; 
        }
         
        .stat-card h3 { 
            font-size: 2.25rem; 
            font-weight: 700; 
            margin: 0.5rem 0; 
            text-shadow: none; 
        }
         
        .form-label { 
            font-weight: 600; 
            color: #374151; 
            margin-bottom: 0.5rem; 
            font-size: 0.875rem;
            text-transform: none;
        }
         
        .form-control, .form-select { 
            border: 1px solid #D1D5DB; 
            border-radius: var(--border-radius-sm); 
            padding: 0.625rem 0.875rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease; 
            font-size: 0.95rem; 
        }
         
        .form-control:focus, .form-select:focus {
            border-color: var(--asparagus);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
            outline: none;
        }
         
        .btn-primary { 
            background: var(--asparagus); 
            border: none; 
            border-radius: var(--border-radius-sm); 
            padding: 0.75rem 1.5rem; 
            font-weight: 600; 
            font-size: 1rem; 
            transition: all 0.2s ease; 
            box-shadow: none; 
        }
         
        .btn-primary:hover {
            background: var(--asparagus-dark);
            transform: none;
            box-shadow: var(--shadow-sm);
        }
         
        .recommendation-card { 
            border-left: 4px solid var(--asparagus); 
            background: var(--white); 
            border: 1px solid #E5E7EB;
            border-left: 4px solid var(--asparagus);
            transition: all 0.2s ease; 
            border-radius: var(--border-radius-md); 
            margin-bottom: 1rem; 
            padding: 1.25rem; 
        }
         
        .recommendation-card:hover { 
            border-left-color: var(--asparagus-dark); 
            background: #F9FAFB; 
            transform: translateX(2px); 
            box-shadow: var(--shadow-sm);
        }
         
        .badge-savings { 
            background: #D1FAE5; 
            color: #065F46;
            padding: 0.5rem 0.75rem; 
            border-radius: var(--border-radius-sm); 
            font-weight: 600; 
            font-size: 0.875rem; 
        }
         
        .badge-increase { 
            background: linear-gradient(135deg, #d62828 0%, #dc143c 100%); 
            padding: 0.6rem 1.25rem; 
            border-radius: 10px; 
            font-weight: 700; 
            font-size: 1rem; 
        } 
         
        .loading-spinner { 
            padding: 4rem; 
            text-align: center; 
        } 
         
        .spinner-border { 
            width: 4rem; 
            height: 4rem; 
            border-width: 0.4rem; 
            color: var(--asparagus); 
        } 
         
        .hidden { 
            display: none; 
        } 
         
        .fade-in { 
            animation: fadeIn 0.6s ease-out; 
        } 
         
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        } 
         
        .comparison-card { 
            background: var(--white); 
            border: 1px solid #E5E7EB; 
            border-radius: var(--border-radius-md); 
            padding: 1.5rem; 
            transition: all 0.2s ease; 
            text-align: center; 
        }
         
        .comparison-card:hover { 
            border-color: var(--asparagus); 
            box-shadow: var(--shadow-md); 
            transform: scale(1.02); 
        }
         
        .material-checkbox { 
            cursor: pointer; 
            padding: 1rem; 
            border: 1px solid #D1D5DB; 
            border-radius: var(--border-radius-sm); 
            transition: all 0.2s ease; 
            text-align: center; 
        }
         
        .material-checkbox:hover { 
            border-color: var(--asparagus); 
            background: #F3F4F6; 
        }
         
        .material-checkbox input:checked ~ label { 
            color: var(--asparagus); 
            font-weight: 800; 
        } 
         
        .upload-zone { 
            border: 2px dashed #9CA3AF; 
            border-radius: var(--border-radius-md); 
            padding: 2.5rem; 
            text-align: center; 
            background: #F9FAFB; 
            transition: all 0.2s ease; 
            cursor: pointer; 
        }
         
        .upload-zone:hover { 
            border-color: var(--asparagus); 
            background: #F3F4F6; 
            box-shadow: var(--shadow-sm);
        }
         
        .chart-container { 
            position: relative; 
            height: 350px; 
            padding: 1.5rem; 
        } 
         
        .history-item { 
            background: var(--white); 
            border-left: 4px solid #E5E7EB; 
            border: 1px solid #E5E7EB;
            border-left: 4px solid var(--asparagus);
            border-radius: var(--border-radius-md); 
            padding: 1.25rem; 
            margin-bottom: 1rem; 
            transition: all 0.2s ease; 
        }
         
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .stat-card-compact {
            border: none;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .stat-card-compact:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .stat-card-compact .card-body {
            padding: 1.25rem;
        }

        .stat-icon-compact {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .stat-value-compact {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1.2;
            margin: 0.5rem 0 0.25rem 0;
        }

        .stat-label-compact {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6B7280;
            margin: 0;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            background: #D1FAE5;
            color: #065F46;
        }

        .stat-change.negative {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* BI DASHBOARD ENHANCEMENTS */
        .bi-card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            background: white;
            overflow: hidden;
        }

        .bi-card-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-bottom: 2px solid #e9ecef;
            padding: 1.25rem 1.5rem;
        }

        .bi-metric-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .bi-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .bi-metric-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.75rem;
        }

        .bi-metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }

        .bi-metric-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .trend-up {
            background: #D1FAE5;
            color: #065F46;
        }

        .trend-down {
            background: #FEE2E2;
            color: #991B1B;
        }

        .chart-container-enhanced {
            position: relative;
            height: 300px;
            padding: 1rem;
        }

        .chart-legend-custom {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .report-footer {
            text-align: center;
            padding: 12px 0;
            margin-top: 24px;
            background: var(--white);
            border-top: 1px solid #e5e7eb;
            font-size: 8pt;
            color: #6b7280;
        }

        .report-footer .logo {
            font-weight: 700;
            font-size: 10pt;
            color: var(--asparagus);
            letter-spacing: 0.5px;
        }

        .report-footer p {
            margin: 2px 0;
        }
        
        /* ============================================================================
        AI CHATBOT STYLES
        ============================================================================ */

        #chatbot-container {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 9999;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }

        /* Chat Bubble (Collapsed) */
        #chat-bubble {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--asparagus) 0%, #229954 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(39, 174, 96, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 10000; 
        }

        #chat-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(39, 174, 96, 0.5);
        }

        #chat-bubble i {
            font-size: 1.8rem;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            border: 2px solid white;
            animation: bounceIn 0.5s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Chat Window (Expanded) */
        #chat-window {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--asparagus);
        }

        .chat-control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
        }

        .chat-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* Messages Area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            background: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Message Bubbles */
        .message {
            display: flex;
            gap: 0.75rem;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                transform: translateY(10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .bot-message .message-avatar {
            background: linear-gradient(135deg, var(--asparagus) 0%, #229954 100%);
            color: white;
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .message-content {
            background: white;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            max-width: 75%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            word-wrap: break-word;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .message-content strong {
            font-size: 0.85rem;
            display: block;
            margin-bottom: 0.35rem;
            opacity: 0.8;
        }

        .message-content p {
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .message-content ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.2rem;
        }

        .message-content li {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 0.3rem;
            padding: 0.5rem 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--asparagus);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Quick Actions */
        .chat-quick-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1rem 0.5rem 1rem;
            background: white;
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
        }

        .chat-quick-actions::-webkit-scrollbar {
            height: 4px;
        }

        .quick-action-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            padding: 0.5rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .quick-action-btn:hover {
            background: var(--asparagus);
            color: white;
            border-color: var(--asparagus);
            transform: translateY(-1px);
        }

        .quick-action-btn i {
            font-size: 0.9rem;
        }

        /* Input Area */
        .chat-input-container {
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .chat-input-wrapper {
            display: flex;
            padding: 1rem;
            gap: 0.75rem;
        }

        #chat-input {
            flex: 1;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }

        #chat-input:focus {
            border-color: var(--asparagus);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        #chat-send-btn {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--asparagus) 0%, #229954 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1.1rem;
        }

        #chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        #chat-send-btn:active {
            transform: scale(0.95);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #chat-window {
                width: calc(100vw - 20px);
                height: calc(100vh - 100px);
                right: 10px;
                bottom: 10px;
            }
            
            #chat-bubble {
                right: 15px;
                bottom: 15px;
            }
        }

        /* Error/Info Messages */
        .error-message {
            background: #fee2e2 !important;
            border-left: 4px solid #dc2626;
            color: #991b1b;
        }

        .info-message {
            background: #dbeafe !important;
            border-left: 4px solid #2563eb;
            color: #1e40af;
        }
    </style> 
</head> 
<body> 
    <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem 2rem; border-bottom: 3px solid var(--asparagus);">
        <div class="container-fluid">
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                    <div style="width: 45px; height: 45px; background: linear-gradient(135deg, var(--asparagus) 0%, #229954 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);">
                        <i class="bi bi-box-seam-fill" style="font-size: 1.5rem; color: white;"></i>
                    </div>
                    <div>
                        <span class="navbar-brand mb-0" style="font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px;">
                            EcoPackAI
                        </span>
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-top: -4px; font-weight: 500;">
                            Smart Packaging Intelligence Platform
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center gap-4">
                <div class="text-end">
                    <div class="text-white" style="font-size: 0.95rem; font-weight: 600;" id="userName">Welcome, User</div>
                    <small style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">Business Analytics Dashboard</small>
                </div>
                <button class="btn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem 1.25rem; border-radius: 8px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-2"></i> Sign Out
                </button>
            </div>
        </div>
    </nav>
 
    <div class="container-fluid"> 
        <div class="row"> 
            <div class="col-md-2 sidebar"> 
                <ul class="nav nav-pills flex-column"> 
                    <li class="nav-item"> 
                        <a class="nav-link active" href="#" onclick="showSection(event, 'recommendation')"> 
                            <i class="bi bi-box-seam-fill"></i> 
                            <span>Recommendations</span> 
                        </a> 
                    </li> 
                    <li class="nav-item"> 
                        <a class="nav-link" href="#" onclick="showSection(event, 'compare')"> 
                            <i class="bi bi-arrow-left-right"></i> 
                            <span>Compare</span> 
                        </a> 
                    </li> 
                    <li class="nav-item"> 
                        <a class="nav-link" href="#" onclick="showSection(event, 'bulk')"> 
                            <i class="bi bi-cloud-upload-fill"></i> 
                            <span>Bulk Upload</span> 
                        </a> 
                    </li> 
                    <li class="nav-item"> 
                        <a class="nav-link" href="#" onclick="showSection(event, 'analytics')"> 
                            <i class="bi bi-graph-up-arrow"></i> 
                            <span>Analytics</span> 
                        </a> 
                    </li> 
                    <li class="nav-item"> 
                        <a class="nav-link" href="#" onclick="showSection(event, 'history')"> 
                            <i class="bi bi-clock-history"></i> 
                            <span>History</span> 
                        </a> 
                    </li> 
                </ul> 
            </div> 
 
            <div class="col-md-10 p-4"> 
 
                <!-- RECOMMENDATION SECTION --> 
                <div id="recommendationSection" class="section">

                <!-- ENHANCED COMPACT KPI CARDS -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card-compact">
                            <div class="card-body">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="stat-icon-compact" style="background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);">
                                        <i class="bi bi-box-seam-fill" style="color: #6366F1;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="stat-label-compact">Total Recommendations</p>
                                        <h3 class="stat-value-compact" id="totalRecs" style="color: #1F2937;">0</h3>
                                        <span class="stat-change positive">
                                            <i class="bi bi-arrow-up-short"></i> Active
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card stat-card-compact">
                            <div class="card-body">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="stat-icon-compact" style="background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);">
                                        <i class="bi bi-currency-rupee" style="color: #0EA5E9;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="stat-label-compact">Cost Savings</p>
                                        <h3 class="stat-value-compact" id="totalCost" style="color: #1F2937;">â‚¹0</h3>
                                        <span class="stat-change positive" id="costTrend">
                                            <i class="bi bi-arrow-down-short"></i> Optimized
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card stat-card-compact">
                            <div class="card-body">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="stat-icon-compact" style="background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);">
                                        <i class="bi bi-cloud-fill" style="color: #22C55E;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="stat-label-compact">COâ‚‚ Impact</p>
                                        <h3 class="stat-value-compact" id="totalCO2" style="color: #1F2937;">0</h3>
                                        <span class="stat-change positive" id="co2Trend">
                                            <i class="bi bi-arrow-down-short"></i> Reduced
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card stat-card-compact">
                            <div class="card-body">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="stat-icon-compact" style="background: linear-gradient(135deg, #FED7AA 0%, #FDBA74 100%);">
                                        <i class="bi bi-recycle" style="color: #F97316;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="stat-label-compact">Sustainability</p>
                                        <h3 class="stat-value-compact" style="color: #1F2937;">95%</h3>
                                        <span class="stat-change positive">
                                            <i class="bi bi-check-circle-fill"></i> Excellent
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <div class="card mb-4"> 
                        <div class="card-header"> 
                            <h4><i class=style="color: var(--asparagus);"></i> Get Food Packaging Recommendations</h4> 
                        </div>
                        <div class="card-body p-4"> 
                            <form id="recForm"> 
                                <div class="row"> 
                                    <div class="col-md-4 mb-3"> 
                                        <label class="form-label">Product Quantity (g)</label> 
                                        <input type="number" class="form-control" id="pq" value="500" required> 
                                    </div> 
                                    <div class="col-md-4 mb-3"> 
                                        <label class="form-label">Package Weight (g)</label> 
                                        <input type="number" class="form-control" id="pw" value="50" required> 
                                    </div> 
                                    <div class="col-md-4 mb-3"> 
                                        <label class="form-label">Weight Capacity (g)</label> 
                                        <input type="number" class="form-control" id="wc" value="600" required> 
                                    </div> 
                                </div> 
                                <div class="row"> 
                                    <div class="col-md-3 mb-3"> 
                                        <label class="form-label">Number of Units</label> 
                                        <input type="number" class="form-control" id="nu" value="1" min="1" required> 
                                    </div> 
                                    <div class="col-md-3 mb-3"> 
                                        <label class="form-label">Recyclability %</label> 
                                        <input type="number" class="form-control" id="rp" value="70" min="0" max="100" required> 
                                    </div> 
                                    <div class="col-md-3 mb-3"> 
                                        <label class="form-label">Material</label> 
                                        <select class="form-select" id="mat" required> 
                                            <option value="aluminium">Aluminium</option>
                                            <option value="cardboard">Cardboard</option>
                                            <option value="glass">Glass</option>
                                            <option value="metal">Metal</option>
                                            <option value="paper">Paper</option>
                                            <option value="plastic">Plastic</option>
                                            <option value="plastic 7">Plastic 7</option>
                                            <option value="steel">Steel</option>
                                    </select> 
                                    </div> 
                                    <div class="col-md-3 mb-3"> 
                                        <label class="form-label">Shape</label> 
                                        <select class="form-select" id="shape" required> 
                                            <option value="accessory">Accessory</option>
                                            <option value="aerosol">Aerosol</option>
                                            <option value="backing">Backing</option>
                                            <option value="bag">Bag</option>
                                            <option value="basket">Basket</option>
                                            <option value="blister">Blister</option>
                                            <option value="bottle">Bottle</option>
                                            <option value="bowl">Bowl</option>
                                            <option value="box">Box</option>
                                            <option value="brick">Brick</option>
                                            <option value="bucket">Bucket</option>
                                            <option value="cage">Cage</option>
                                            <option value="can">Can</option>
                                            <option value="cap">Cap</option>
                                            <option value="capsule">Capsule</option>
                                            <option value="card">Card</option>
                                            <option value="container">Container</option>
                                            <option value="cork">Cork</option>
                                            <option value="cylinder">Cylinder</option>
                                            <option value="envelope">Envelope</option>
                                            <option value="fastener">Fastener</option>
                                            <option value="filling">Filling</option>
                                            <option value="film">Film</option>
                                            <option value="fork">Fork</option>
                                            <option value="handle">Handle</option>
                                            <option value="jar">Jar</option>
                                            <option value="jug">Jug</option>
                                            <option value="label">Label</option>
                                            <option value="lid">Lid</option>
                                            <option value="mold">Mold</option>
                                            <option value="net">Net</option>
                                            <option value="overpack">Overpack</option>
                                            <option value="packaging">Packaging</option>
                                            <option value="packet">Packet</option>
                                            <option value="plate">Plate</option>
                                            <option value="pot">Pot</option>
                                            <option value="pouch">Pouch</option>
                                            <option value="ring">Ring</option>
                                            <option value="roll">Roll</option>
                                            <option value="seal">Seal</option>
                                            <option value="sheet">Sheet</option>
                                            <option value="sleeve">Sleeve</option>
                                            <option value="spoon">Spoon</option>
                                            <option value="spout">Spout</option>
                                            <option value="stick">Stick</option>
                                            <option value="straw">Straw</option>
                                            <option value="strip">Strip</option>
                                            <option value="tie">Tie</option>
                                            <option value="tray">Tray</option>
                                            <option value="tube">Tube</option>
                                            <option value="tumbler">Tumbler</option>
                                            <option value="vial">Vial</option>
                                            <option value="wedge">Wedge</option>
                                            <option value="wrap">Wrap</option>
                                            <option value="wrapper">Wrapper</option>
                                        </select> 
                                    </div> 
                                </div> 
                                <div class="row"> 
                                    <div class="col-md-3 mb-3"> 
                                        <label class="form-label">Strength</label> 
                                        <select class="form-select" id="str" required> 
                                            <option value="High">High</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium" selected>Medium</option>
                                            <option value="Very High">Very High</option>
                                        </select> 
                                    </div> 
                                    <div class="col-md-3 mb-3"> 
                                        <label class="form-label">Recycling Type</label> 
                                        <select class="form-select" id="rec" required> 
                                            <option value="Compost">Compost</option>
                                            <option value="Deposit Return">Deposit Return</option>
                                            <option value="Film as Plastic">Film as Plastic</option>
                                            <option value="Inner Package as Paper">Inner Package as Paper</option>
                                            <option value="Not Recyclable">Not Recyclable</option>
                                            <option value="Plastic Bag - Discard">Plastic Bag - Discard</option>
                                            <option value="Recyclable" selected>Recyclable</option>
                                            <option value="Recyclable Bag Clip">Recyclable Bag Clip</option>
                                            <option value="Return to Store">Return to Store</option>
                                            <option value="Reusable">Reusable</option>
                                            <option value="Reuse">Reuse</option>
                                        </select> 
                                    </div> 
                                    <div class="col-md-3 mb-3"> 
                                        <label class="form-label">
                                            <i class="bi bi-basket3 me-1" style="color: var(--asparagus);"></i>
                                            Food Product Category
                                        </label>
                                        <select class="form-select" id="fg" required>
                                            <option value="alcoholic-beverages">Alcoholic Beverages</option>
                                            <option value="appetizers">Appetizers</option>
                                            <option value="artificially-sweetened-beverages">Artificially Sweetened Beverages</option>
                                            <option value="biscuits-and-cakes">Biscuits & Cakes</option>
                                            <option value="bread">Bread</option>
                                            <option value="breakfast-cereals">Breakfast Cereals</option>
                                            <option value="cereals">Cereals</option>
                                            <option value="cereals-and-potatoes">Cereals & Potatoes</option>
                                            <option value="cheese">Cheese</option>
                                            <option value="chocolate-products">Chocolate Products</option>
                                            <option value="dairy-desserts">Dairy Desserts</option>
                                            <option value="dressings-and-sauces">Dressings & Sauces</option>
                                            <option value="dried-fruits">Dried Fruits</option>
                                            <option value="eggs">Eggs</option>
                                            <option value="fats">Fats</option>
                                            <option value="fatty-fish">Fatty Fish</option>
                                            <option value="fish-and-seafood">Fish & Seafood</option>
                                            <option value="fish-meat-eggs">Fish, Meat & Eggs</option>
                                            <option value="fruit-juices">Fruit Juices</option>
                                            <option value="fruit-nectars">Fruit Nectars</option>
                                            <option value="fruits">Fruits</option>
                                            <option value="ice-cream">Ice Cream</option>
                                            <option value="lean-fish">Lean Fish</option>
                                            <option value="legumes">Legumes</option>
                                            <option value="meat-other-than-poultry">Meat (Other than Poultry)</option>
                                            <option value="milk-and-yogurt">Milk & Yogurt</option>
                                            <option value="nuts">Nuts</option>
                                            <option value="offals">Offals</option>
                                            <option value="one-dish-meals">One Dish Meals</option>
                                            <option value="pastries">Pastries</option>
                                            <option value="pizza-pies-and-quiches">Pizza, Pies & Quiches</option>
                                            <option value="plant-based-milk-substitutes">Plant-based Milk Substitutes</option>
                                            <option value="potatoes">Potatoes</option>
                                            <option value="poultry">Poultry</option>
                                            <option value="processed-meat">Processed Meat</option>
                                            <option value="salty-and-fatty-products">Salty & Fatty Products</option>
                                            <option value="sandwiches">Sandwiches</option>
                                            <option value="soups">Soups</option>
                                            <option value="sweetened-beverages">Sweetened Beverages</option>
                                            <option value="sweets">Sweets</option>
                                            <option value="teas-and-herbal-teas-and-coffees">Teas, Herbal Teas & Coffees</option>
                                            <option value="unsweetened-beverages">Unsweetened Beverages</option>
                                            <option value="vegetables">Vegetables</option>
                                            <option value="waters-and-flavored-waters">Waters & Flavored Waters</option>
                                        </select> 
                                    </div> 
                                    <div class="col-md-3 mb-3"> 
                                        <label class="form-label">No. of Alternatives</label> 
                                        <input type="number" class="form-control" id="n_alts" value="5" min="1" max="10" required> 
                                    </div> 
                                </div> 
                                <button type="submit" class="btn btn-primary btn-lg"> 
                                    <i class="bi bi-search"></i> Get Recommendations 
                                </button> 
                            </form> 
                            <div class="loading-spinner hidden" id="recLoading"> 
                                <div class="spinner-border"></div> 
                                <p class="mt-3 fw-bold fs-5">Analyzing alternatives...</p> 
                            </div> 
                        </div> 
                    </div> 
                    <div id="recResults" class="hidden"></div> 
                </div> 
 
                <!-- COMPARE SECTION --> 
                <div id="compareSection" class="section hidden"> 
                    <div class="card"> 
                        <div class="card-header"> 
                            <h4><i class="bi bi-arrow-left-right"></i> Compare Materials Side-by-Side</h4> 
                        </div> 
                        <div class="card-body p-4"> 
                            <form id="compForm"> 
                                <div class="row mb-4"> 
                                    <div class="col-md-3"> 
                                        <label class="form-label">Product Quantity (g)</label> 
                                        <input type="number" class="form-control" id="cq" value="500"> 
                                    </div> 
                                    <div class="col-md-3"> 
                                        <label class="form-label">Package Weight (g)</label> 
                                        <input type="number" class="form-control" id="cw" value="50"> 
                                    </div> 
                                    <div class="col-md-3"> 
                                        <label class="form-label">Weight Capacity (g)</label> 
                                        <input type="number" class="form-control" id="cwc" value="600"> 
                                    </div> 
                                    <div class="col-md-3"> 
                                        <label class="form-label">Shape</label> 
                                        <select class="form-select" id="cs"> 
                                            <option value="accessory">Accessory</option>
                                            <option value="aerosol">Aerosol</option>
                                            <option value="backing">Backing</option>
                                            <option value="bag">Bag</option>
                                            <option value="basket">Basket</option>
                                            <option value="blister">Blister</option>
                                            <option value="bottle" selected>Bottle</option>
                                            <option value="bowl">Bowl</option>
                                            <option value="box">Box</option>
                                            <option value="brick">Brick</option>
                                            <option value="bucket">Bucket</option>
                                            <option value="cage">Cage</option>
                                            <option value="can">Can</option>
                                            <option value="cap">Cap</option>
                                            <option value="capsule">Capsule</option>
                                            <option value="card">Card</option>
                                            <option value="container">Container</option>
                                            <option value="cork">Cork</option>
                                            <option value="cylinder">Cylinder</option>
                                            <option value="envelope">Envelope</option>
                                            <option value="fastener">Fastener</option>
                                            <option value="filling">Filling</option>
                                            <option value="film">Film</option>
                                            <option value="fork">Fork</option>
                                            <option value="handle">Handle</option>
                                            <option value="jar">Jar</option>
                                            <option value="jug">Jug</option>
                                            <option value="label">Label</option>
                                            <option value="lid">Lid</option>
                                            <option value="mold">Mold</option>
                                            <option value="net">Net</option>
                                            <option value="overpack">Overpack</option>
                                            <option value="packaging">Packaging</option>
                                            <option value="packet">Packet</option>
                                            <option value="plate">Plate</option>
                                            <option value="pot">Pot</option>
                                            <option value="pouch">Pouch</option>
                                            <option value="ring">Ring</option>
                                            <option value="roll">Roll</option>
                                            <option value="seal">Seal</option>
                                            <option value="sheet">Sheet</option>
                                            <option value="sleeve">Sleeve</option>
                                            <option value="spoon">Spoon</option>
                                            <option value="spout">Spout</option>
                                            <option value="stick">Stick</option>
                                            <option value="straw">Straw</option>
                                            <option value="strip">Strip</option>
                                            <option value="tie">Tie</option>
                                            <option value="tray">Tray</option>
                                            <option value="tube">Tube</option>
                                            <option value="tumbler">Tumbler</option>
                                            <option value="vial">Vial</option>
                                            <option value="wedge">Wedge</option>
                                            <option value="wrap">Wrap</option>
                                            <option value="wrapper">Wrapper</option>
                                        </select> 
                                    </div>
                                </div> 
                                <div class="mb-4"> 
                                    <label class="form-label">Select Materials to Compare (2-5)</label> 
                                    <div class="row"> 
                                        <div class="col-md-2 mb-2"> 
                                            <div class="material-checkbox"> 
                                                <input type="checkbox" class="form-check-input" value="aluminium" id="m1"> 
                                                <label class="form-check-label d-block mt-2 fw-bold" for="m1">Aluminium</label> 
                                            </div> 
                                        </div> 
                                        <div class="col-md-2 mb-2"> 
                                            <div class="material-checkbox"> 
                                                <input type="checkbox" class="form-check-input" value="cardboard" id="m2"> 
                                                <label class="form-check-label d-block mt-2 fw-bold" for="m2">Cardboard</label> 
                                            </div> 
                                        </div> 
                                        <div class="col-md-2 mb-2"> 
                                            <div class="material-checkbox"> 
                                                <input type="checkbox" class="form-check-input" value="glass" id="m3"> 
                                                <label class="form-check-label d-block mt-2 fw-bold" for="m3">Glass</label> 
                                            </div> 
                                        </div> 
                                        <div class="col-md-2 mb-2"> 
                                            <div class="material-checkbox"> 
                                                <input type="checkbox" class="form-check-input" value="metal" id="m4"> 
                                                <label class="form-check-label d-block mt-2 fw-bold" for="m4">Metal</label> 
                                            </div> 
                                        </div> 
                                        <div class="col-md-2 mb-2"> 
                                            <div class="material-checkbox"> 
                                                <input type="checkbox" class="form-check-input" value="paper" id="m5"> 
                                                <label class="form-check-label d-block mt-2 fw-bold" for="m5">Paper</label> 
                                            </div> 
                                        </div> 
                                        <div class="col-md-2 mb-2"> 
                                            <div class="material-checkbox"> 
                                                <input type="checkbox" class="form-check-input" value="plastic" id="m6"> 
                                                <label class="form-check-label d-block mt-2 fw-bold" for="m6">Plastic</label> 
                                            </div> 
                                        </div> 
                                        <div class="col-md-2 mb-2"> 
                                            <div class="material-checkbox"> 
                                                <input type="checkbox" class="form-check-input" value="plastic 7" id="m7"> 
                                                <label class="form-check-label d-block mt-2 fw-bold" for="m7">Plastic 7</label> 
                                            </div> 
                                        </div> 
                                        <div class="col-md-2 mb-2"> 
                                            <div class="material-checkbox"> 
                                                <input type="checkbox" class="form-check-input" value="steel" id="m8"> 
                                                <label class="form-check-label d-block mt-2 fw-bold" for="m8">Steel</label> 
                                            </div> 
                                        </div>
                                    </div> 
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg"> 
                                    <i class="bi bi-graph-up"></i> Compare Materials 
                                </button> 
                            </form> 
                            <div class="loading-spinner hidden" id="compLoading"> 
                                <div class="spinner-border"></div> 
                                <p class="mt-3 fw-bold fs-5">Comparing materials...</p> 
                            </div> 
                        </div> 
                    </div> 
                    <div id="compResults" class="hidden"></div> 
                </div> 
 
                <!-- BULK UPLOAD SECTION --> 
                <div id="bulkSection" class="section hidden"> 
                    <div class="card"> 
                        <div class="card-header"> 
                            <h4><i class="bi bi-cloud-upload-fill"></i> Bulk Upload & Process</h4> 
                        </div> 
                        <div class="card-body p-4"> 
                            <div class="upload-zone" onclick="document.getElementById('fileInput').click()"> 
                                <i class="bi bi-cloud-upload-fill" style="font-size: 3.5rem; color: var(--burlywood);"></i> 
                                <h4 class="fw-bold mt-3 mb-2">Upload CSV or Excel File</h4> 
                                <p class="text-muted mb-0" style="font-size: 0.9rem;">Click to browse â€¢ Max 10MB</p>
                                <input type="file" id="fileInput" class="d-none" accept=".csv,.xlsx,.xls" onchange="handleBulk(event)"> 
                            </div>
                            <div class="loading-spinner hidden" id="bulkLoading"> 
                                <div class="spinner-border"></div> 
                                <p class="mt-3 fw-bold fs-5">Processing your file...</p> 
                            </div> 
                            <div id="bulkResults" class="hidden mt-4"></div>
                            <div id="bulkDownload" class="hidden mt-3 text-center">
                                <button class="btn btn-primary btn-lg" onclick="downloadBulkResults()">
                                    <i class="bi bi-download"></i> Download Results as CSV
                                </button>
                            </div>
                        </div> 
                    </div> 
                </div> 
 
                <!-- ANALYTICS SECTION --> 
                <div id="analyticsSection" class="section hidden"> 
                    <!-- Header with Export Buttons -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="fw-bold mb-1">Business Intelligence Dashboard</h3>
                            <p class="text-muted mb-0">Comprehensive analytics and performance metrics</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success" onclick="exportAnalyticsExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Export Excel
                            </button>
                            <button class="btn btn-outline-danger" onclick="exportAnalyticsPDF()">
                                <i class="bi bi-file-earmark-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>

                    <!-- Compact Executive Summary Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3 col-sm-6">
                            <div class="card" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-graph-up-arrow" style="color: #6366F1; font-size: 1.25rem;"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0" style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #6B7280; letter-spacing: 0.5px;">Avg Savings</p>
                                                <h4 class="mb-0 fw-bold" id="analyticsAvgSavings" style="color: #6366F1; font-size: 1.5rem;">â‚¹0.00</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1" style="font-size: 0.7rem;">
                                        <span class="badge" style="background: #D1FAE5; color: #065F46; padding: 2px 6px;">
                                            <i class="bi bi-arrow-up-short"></i> Performance
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-sm-6">
                            <div class="card" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-cloud-arrow-down" style="color: #22C55E; font-size: 1.25rem;"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0" style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #6B7280; letter-spacing: 0.5px;">Avg COâ‚‚</p>
                                                <h4 class="mb-0 fw-bold" id="analyticsAvgCO2" style="color: #22C55E; font-size: 1.5rem;">0.00</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1" style="font-size: 0.7rem;">
                                        <span class="badge" style="background: #D1FAE5; color: #065F46; padding: 2px 6px;">
                                            <i class="bi bi-leaf-fill"></i> Environmental
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-sm-6">
                            <div class="card" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-calendar-check" style="color: #0EA5E9; font-size: 1.25rem;"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0" style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #6B7280; letter-spacing: 0.5px;">This Month</p>
                                                <h4 class="mb-0 fw-bold" id="analyticsThisMonth" style="color: #0EA5E9; font-size: 1.5rem;">0</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1" style="font-size: 0.7rem;">
                                        <span class="badge" style="background: #DBEAFE; color: #0369A1; padding: 2px 6px;">
                                            <i class="bi bi-clock-history"></i> Active
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-sm-6">
                            <div class="card" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-trophy-fill" style="color: #F59E0B; font-size: 1.25rem;"></i>
                                            </div>
                                            <div>
                                                <p class="mb-0" style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #6B7280; letter-spacing: 0.5px;">Best Saving</p>
                                                <h4 class="mb-0 fw-bold" id="analyticsBestSaving" style="color: #F59E0B; font-size: 1.5rem;">â‚¹0.00</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1" style="font-size: 0.7rem;">
                                        <span class="badge" style="background: #FEF3C7; color: #92400E; padding: 2px 6px;">
                                            <i class="bi bi-star-fill"></i> Record
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Trends - EQUAL SIZE CHARTS -->
                    <div class="row g-3 mb-4">
                        <div class="col-lg-6">
                            <div class="bi-card">
                                <div class="bi-card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1 fw-bold"><i class="bi bi-bar-chart-fill text-primary me-2"></i>Cost Savings Trend</h5>
                                            <small class="text-muted">Track cost optimization over time</small>
                                        </div>
                                        <span class="badge bg-light text-dark border">
                                            <i class="bi bi-arrow-up text-success"></i> Trending
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container-enhanced" style="height: 300px;">
                                        <canvas id="costChart"></canvas>
                                    </div>
                                    <div class="row text-center mt-3 pt-3 border-top">
                                        <div class="col-6">
                                            <small class="text-muted d-block mb-1">Total Saved</small>
                                            <strong class="text-primary" id="costChartTotal">â‚¹0.00</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block mb-1">Best Period</small>
                                            <strong class="text-primary" id="costChartBest">Rec 1</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="bi-card">
                                <div class="bi-card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1 fw-bold"><i class="bi bi-cloud-fill text-success me-2"></i>COâ‚‚ Reduction Trend</h5>
                                            <small class="text-muted">Monitor environmental impact</small>
                                        </div>
                                        <span class="badge bg-light text-dark border">
                                            <i class="bi bi-graph-down text-success"></i> Impact
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container-enhanced" style="height: 300px;">
                                        <canvas id="co2Chart"></canvas>
                                    </div>
                                    <div class="row text-center mt-3 pt-3 border-top">
                                        <div class="col-6">
                                            <small class="text-muted d-block mb-1">Total Reduced</small>
                                            <strong class="text-success" id="co2ChartTotal">0.00</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block mb-1">Best Period</small>
                                            <strong class="text-success" id="co2ChartBest">Rec 1</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Material Distribution & Performance Matrix - EQUAL SIZE -->
                    <div class="row g-3 mb-4">
                        <div class="col-lg-6">
                            <div class="bi-card" style="height: 100%;">
                                <div class="bi-card-header">
                                    <h5 class="mb-0 fw-bold"><i class="bi bi-pie-chart-fill me-2"></i>Material Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container-enhanced" style="height: 280px;">
                                        <canvas id="materialDistChart"></canvas>
                                    </div>
                                    <div class="text-center mt-3 pt-3 border-top">
                                        <small class="text-muted">Most used materials in your recommendations</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="bi-card" style="height: 100%;">
                                <div class="bi-card-header">
                                    <h5 class="mb-0 fw-bold"><i class="bi bi-speedometer2 me-2"></i>Performance Scorecard</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0" style="font-size: 0.9rem;">
                                            <thead style="background: #f8f9fa;">
                                                <tr>
                                                    <th style="padding: 0.75rem;">Metric</th>
                                                    <th style="padding: 0.75rem;">Value</th>
                                                    <th style="padding: 0.75rem;">Target</th>
                                                    <th style="padding: 0.75rem;">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="performanceMatrix">
                                                <tr>
                                                    <td style="padding: 0.75rem;"><strong>Avg Cost Savings</strong></td>
                                                    <td style="padding: 0.75rem;" id="pmCostThis">â‚¹0.00</td>
                                                    <td style="padding: 0.75rem;">â‚¹250+</td>
                                                    <td style="padding: 0.75rem;"><span class="badge bg-success">On Track</span></td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.75rem;"><strong>Avg COâ‚‚ Reduction</strong></td>
                                                    <td style="padding: 0.75rem;" id="pmCO2This">0.00</td>
                                                    <td style="padding: 0.75rem;">50+</td>
                                                    <td style="padding: 0.75rem;"><span class="badge bg-success">Excellent</span></td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.75rem;"><strong>Total Recommendations</strong></td>
                                                    <td style="padding: 0.75rem;" id="pmRecsThis">0</td>
                                                    <td style="padding: 0.75rem;">10+/month</td>
                                                    <td style="padding: 0.75rem;"><span class="badge bg-primary">Active</span></td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 0.75rem;"><strong>Sustainability Score</strong></td>
                                                    <td style="padding: 0.75rem;">95%</td>
                                                    <td style="padding: 0.75rem;">90%+</td>
                                                    <td style="padding: 0.75rem;"><span class="badge bg-success">Achieved</span></td>
                                                </tr>
                                            </tbody>
                                        </table>            
                                    </div>                    
                                </div>                
                            </div>
                        </div>
                    </div>
                </div>
                 
                <!-- HISTORY SECTION --> 
                <div id="historySection" class="section hidden"> 
                    <div class="card"> 
                        <div class="card-header"> 
                            <h4><i class="bi bi-clock-history"></i> Your Recommendation History</h4> 
                        </div>
                        <div class="card-body p-0"> 
                            <div id="historyList"> 
                                <div class="text-center py-5"> 
                                    <div class="spinner-border text-success mb-3"></div> 
                                    <p class="text-muted">Loading your history...</p> 
                                </div> 
                            </div> 
                        </div> 
                    </div> 
                </div>
 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 
    <script> 

// Place this inside <script> tags at the end of dashboard.html body 

const API = '/api';
let token = null; 
let charts = {};

// ============================================================================
// LOAD USER INFO ON PAGE LOAD
// ============================================================================
document.addEventListener('DOMContentLoaded', async () => {
    await loadUserInfo();
    loadAnalytics();
    
    // Show welcome message for first-time users
    const hasSeenWelcome = sessionStorage.getItem('hasSeenWelcome'); // Changed to sessionStorage
    if (!hasSeenWelcome) {
        showWelcomeMessage();
        sessionStorage.setItem('hasSeenWelcome', 'true');
    }
});

async function loadUserInfo() {
    try {
        const res = await fetch('/api/user/info', {
            credentials: 'include'
        });
        
        if (handleAuthError(res)) return;
        
        if (!res.ok) {
            console.error('Failed to load user info');
            return;
        }
        
        const data = await res.json();
        
        if (data.user && data.user.full_name) {
            const firstName = data.user.full_name.split(' ')[0];
            document.getElementById('userName').textContent = `Welcome, ${firstName}`;
        } else {
            document.getElementById('userName').textContent = 'Welcome';
        }
    } catch (e) {
        console.error('Error loading user info:', e);
        document.getElementById('userName').textContent = 'Welcome';
    }
}

function showWelcomeMessage() {
    const welcomeHtml = `
        <div id="welcomeAlert" class="alert alert-success alert-dismissible fade show" style="border-radius: 12px; border-left: 4px solid var(--asparagus); animation: fadeIn 0.5s ease; margin-bottom: 1.5rem;">
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            <h5 class="mb-2"><i class="bi bi-stars me-2"></i>Welcome to EcoPackAI!</h5>
            <p class="mb-0">Your AI-powered assistant for optimizing <strong>food packaging</strong> with cost efficiency and environmental sustainability in mind.</p>
        </div>
    `;
    
    const mainContent = document.querySelector('.col-md-10.p-4');
    if (mainContent) {
        mainContent.insertAdjacentHTML('afterbegin', welcomeHtml);
        
        // Auto-dismiss after 8 seconds
        setTimeout(() => {
            const alert = document.getElementById('welcomeAlert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 8000);
    }
}

function handleAuthError(res) {
    if (res.status === 401) {
        showSessionError();
        return true;
    }
    return false;
}

function showSessionError() {
    if (document.getElementById('sessionErrorAlert')) return;
    
    const alertHtml = `
        <div id="sessionErrorAlert" class="alert alert-danger alert-dismissible fade show fixed-top m-3 shadow" role="alert" style="z-index: 1050;">
            <strong>Session Expired!</strong> Your session has expired or is invalid. Please <a href="#" onclick="logout(); return false;" class="alert-link">log in again</a>.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('afterbegin', alertHtml);
}

 
async function loadAnalytics() {
    try {
        console.log('[Analytics] Fetching data...');
        const res = await fetch(`${API}/analytics/user`, {
            credentials: 'include'
        });
        
        if (handleAuthError(res)) return;

        if (!res.ok) {
            console.error(`[Analytics] API returned ${res.status}`);
            document.getElementById('totalRecs').textContent = '0';
            document.getElementById('totalCost').textContent = 'â‚¹0.00';
            document.getElementById('totalCO2').textContent = '0.00';
            return;
        }
        
        const data = await res.json();
        console.log('[Analytics] Received data:', data);
        
        // ===== CALCULATE FROM HISTORY IF ANALYTICS IS EMPTY =====
        let totalRecs = 0;
        let totalCostSavings = 0;
        let totalCO2Reduction = 0;
        
        if (data.history && data.history.length > 0) {
            console.log(`[Analytics] Processing ${data.history.length} history records`);
            
            totalRecs = data.history.length;
            
            data.history.forEach(record => {
                const costSavings = parseFloat(record.cost_savings) || 0;
                const co2Reduction = parseFloat(record.co2_reduction) || 0;
                
                totalCostSavings += costSavings;
                totalCO2Reduction += co2Reduction;
            });
            
            console.log('[Analytics] Calculated totals:', {
                recs: totalRecs,
                cost: totalCostSavings,
                co2: totalCO2Reduction
            });
        } else if (data.analytics) {
            // Fallback to analytics table
            console.log('[Analytics] Using analytics table data');
            totalRecs = data.analytics.total_recommendations || 0;
            totalCostSavings = parseFloat(data.analytics.total_cost_savings) || 0;
            totalCO2Reduction = parseFloat(data.analytics.total_co2_reduction) || 0;
        }
        
        // ===== UPDATE UI =====
        document.getElementById('totalRecs').textContent = totalRecs;
        
        // Cost handling
        const costElement = document.getElementById('totalCost');
        const costTrend = document.getElementById('costTrend');
        
        if (totalCostSavings >= 0) {
            costElement.textContent = 'â‚¹' + totalCostSavings.toFixed(2);
            costTrend.innerHTML = '<i class="bi bi-arrow-down-short"></i> Optimized';
            costTrend.className = 'stat-change positive';
        } else {
            costElement.textContent = 'â‚¹' + Math.abs(totalCostSavings).toFixed(2);
            costTrend.innerHTML = '<i class="bi bi-arrow-up-short"></i> Increased';
            costTrend.className = 'stat-change negative';
        }
        
        // COâ‚‚ handling
        const co2Element = document.getElementById('totalCO2');
        const co2Trend = document.getElementById('co2Trend');
        
        if (totalCO2Reduction >= 0) {
            co2Element.textContent = totalCO2Reduction.toFixed(2);
            co2Trend.innerHTML = '<i class="bi bi-arrow-down-short"></i> Reduced';
            co2Trend.className = 'stat-change positive';
        } else {
            co2Element.textContent = Math.abs(totalCO2Reduction).toFixed(2);
            co2Trend.innerHTML = '<i class="bi bi-arrow-up-short"></i> Increased';
            co2Trend.className = 'stat-change negative';
        }
        
        console.log('[Analytics] UI updated successfully');
        
    } catch (e) {
        console.error('[Analytics] Error:', e);
        document.getElementById('totalRecs').textContent = '0';
        document.getElementById('totalCost').textContent = 'â‚¹0.00';
        document.getElementById('totalCO2').textContent = '0.00';
    }
}

function showSection(e, name) {
    e.preventDefault();
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    document.getElementById(name + 'Section').classList.remove('hidden');
    e.target.closest('.nav-link').classList.add('active');
    
    if (name === 'history') loadHistory();
    if (name === 'analytics') setTimeout(() => loadCharts(), 100);
}

document.getElementById('recForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const material = document.getElementById('mat').value;
    let parent_material = 'unknown';
    
    if (['aluminium', 'metal', 'steel'].includes(material)) {
        parent_material = 'metal';
    } else if (['cardboard', 'paper'].includes(material)) {
        parent_material = 'paper-or-cardboard';
    } else if (['glass'].includes(material)) {
        parent_material = 'glass';
    } else if (['plastic', 'plastic 7'].includes(material)) {
        parent_material = 'plastic';
    } else {
        parent_material = 'unknown';
    }

    const data = {
        // Numeric fields
        product_quantity: parseFloat(document.getElementById('pq').value),
        weight_measured: parseFloat(document.getElementById('pw').value),
        weight_capacity: parseFloat(document.getElementById('wc').value),
        number_of_units: parseInt(document.getElementById('nu').value),
        recyclability_percent: parseFloat(document.getElementById('rp').value),
        
        // Only the 6 categorical fields models use
        material: material,
        parent_material: parent_material,
        shape: document.getElementById('shape').value,
        strength: document.getElementById('str').value,
        recycling: document.getElementById('rec').value,
        food_group: document.getElementById('fg').value,
        
        // Request parameters
        number_of_alternatives: parseInt(document.getElementById('n_alts').value)
    };
    
    document.getElementById('recLoading').classList.remove('hidden');
    document.getElementById('recResults').classList.add('hidden');
    
    try {
        const res = await fetch(`${API}/recommend`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(data)
        });
        
        if (handleAuthError(res)) return;

        const result = await res.json();
        
        if (res.ok && result.recommendations) {
            // FIX: Backend doesn't return all fields, so add them from form inputs
            result.current_packaging.weight_measured = data.weight_measured;
            result.current_packaging.weight_capacity = data.weight_capacity;
            result.current_packaging.recycling = data.recycling;
            result.current_packaging.food_group = data.food_group;
            result.current_packaging.number_of_units = data.number_of_units;
            result.current_packaging.product_quantity = data.product_quantity;
            
            displayRecs(result);
            loadAnalytics(); // Refresh KPIs after new recommendation
        } else {
            alert('Error: ' + (result.error || 'Failed to get recommendations'));
        }
    } catch (e) {
        alert('Network error: ' + e.message);
    } finally {
        document.getElementById('recLoading').classList.add('hidden');
    }
});

// ============================================================================
// COMPARE FORM
// ============================================================================
document.getElementById('compForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const mats = [];
    document.querySelectorAll('.material-checkbox input:checked').forEach(cb => {
        mats.push(cb.value);
    });
    
    if (mats.length < 2) {
        alert('Please select at least 2 materials to compare');
        return;
    }
    
    const data = {
        materials: mats,
        product_quantity: parseFloat(document.getElementById('cq').value),
        weight_measured: parseFloat(document.getElementById('cw').value),
        weight_capacity: parseFloat(document.getElementById('cwc').value),
        shape: document.getElementById('cs').value,
        strength: 'Medium',
        food_group: 'fruit-juices',
        recyclability_percent: 70,
        number_of_units: 1,
        recycling: 'Recyclable'
    };
    
    document.getElementById('compLoading').classList.remove('hidden');
    document.getElementById('compResults').classList.add('hidden');
    
    try {
        const res = await fetch(`${API}/compare`, {
            method: 'POST',
            credentials: 'include',  
            headers: {
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(data)
        });
        
        if (handleAuthError(res)) return;

        const result = await res.json();
        if (res.ok && result.comparisons) {
            displayComp(result, data);  // â† Now passing both result AND input data
        } else {
            alert('Error: ' + (result.error || 'Comparison failed'));
        }
    } catch (e) {
        alert('Comparison error: ' + e.message);
    } finally {
        document.getElementById('compLoading').classList.add('hidden');
    }
});

// ============================================================================
// BULK UPLOAD
// ============================================================================
async function handleBulk(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file type
    const validExtensions = ['csv', 'xlsx', 'xls'];
    const fileExtension = file.name.split('.').pop().toLowerCase();
    if (!validExtensions.includes(fileExtension)) {
        alert('Please upload a CSV or Excel file (.csv, .xlsx, .xls)');
        e.target.value = '';
        return;
    }
    
    // Check file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File size exceeds 10MB. Please upload a smaller file.');
        e.target.value = '';
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    document.getElementById('bulkLoading').classList.remove('hidden');
    document.getElementById('bulkResults').classList.add('hidden');
    document.getElementById('bulkDownload').classList.add('hidden');
    
    try {
        const res = await fetch(`${API}/bulk-upload`, {
            method: 'POST',
            credentials: 'include',  
            body: formData
        });
        
        if (handleAuthError(res)) return;

        if (!res.ok) {
            const errorData = await res.json().catch(() => ({ error: 'Unknown error' }));
            throw new Error(errorData.error || `Server error: ${res.status}`);
        }

        const result = await res.json();
        
        if (!result.results || result.results.length === 0) {
            throw new Error('No valid results returned from server');
        }
        
        displayBulk(result);
        loadAnalytics();
    } catch (e) {
        console.error('Bulk upload error:', e);
        document.getElementById('bulkResults').innerHTML = `
            <div class="alert alert-danger fade-in" style="border-radius: 12px; border: 2px solid #dc3545;">
                <h5 class="mb-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>Upload Failed</h5>
                <p class="mb-1"><strong>Error:</strong> ${e.message}</p>
                <hr>
                <p class="mb-0 small">
                    <strong>Common issues:</strong><br>
                    â€¢ Missing required columns (product_quantity, weight_measured, weight_capacity, material, shape, strength, food_group)<br>
                    â€¢ Invalid data format or values<br>
                    â€¢ File is corrupted or empty<br>
                    â€¢ Column names don't match expected format
                </p>
            </div>
        `;
        document.getElementById('bulkResults').classList.remove('hidden');
    } finally {
        document.getElementById('bulkLoading').classList.add('hidden');
        e.target.value = ''; // Reset file input
    }
}

function displayRecs(data) {
    const c = data.current_packaging;
    const r = data.recommendations;
    
    console.log('=== DISPLAY RECS DEBUG ===');
    console.log('Current packaging:', c);
    console.log('Recommendations:', r);
    console.log('Total cost:', c.total_cost);
    console.log('Cost:', c.cost);
    console.log('==========================');
    
    // Helper function to format values with fallback
    const formatValue = (val, unit = '', fallback = 'N/A') => {
        return (val !== null && val !== undefined && val !== '' && !isNaN(val)) ? `${parseFloat(val).toFixed(2)}${unit}` : fallback;
    };

    // Find the best recommendation
    const bestRec = r[0]; // Already sorted by improvement_score
    
    // Prepare chart data with ACTUAL material names and correct cost field
    const chartData = {
        labels: [
            `Current\n${c.material}`,
            ...r.slice(0, 5).map(rec => `${rec.material}\n${rec.shape}`)
        ],
        costs: [
            parseFloat(c.total_cost || c.cost || 0),
            ...r.slice(0, 5).map(rec => parseFloat(rec.predicted_cost || 0))
        ],
        co2s: [
            parseFloat(c.co2 || 0),
            ...r.slice(0, 5).map(rec => parseFloat(rec.predicted_co2 || 0))
        ]
    };
    
    console.log('Chart Data Prepared:', chartData);
    
    let html = `
        <!-- Current Packaging Card -->
        <div class="card current-card mb-4 fade-in" style="background: linear-gradient(135deg, #fff 0%, #fef8f5 100%); border: none; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
            <div class="card-header" style="background: var(--white); color: var(--charcoal); padding: 1.25rem 1.5rem; border-bottom: 1px solid #E5E7EB;">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 fw-semibold" style="color: var(--charcoal);"><i class="bi bi-box-seam-fill me-2" style="color: var(--asparagus);"></i>Current Packaging Analysis</h4>
                    <span class="badge" style="background: #E5E7EB; color: #374151; padding: 0.4rem 1rem; font-size: 0.9rem; font-weight: 600;">Baseline</span>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    <!-- Specifications Column -->
                    <div class="col-md-3">
                        <div class="spec-group">
                            <h6 class="text-muted mb-3" style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">ðŸ“‹ Specifications</h6>
                            <div class="mb-3">
                                <i class="bi bi-box text-primary me-2"></i>
                                <strong>Material:</strong> <span class="text-capitalize badge bg-primary">${c.material}</span>
                            </div>
                            <div class="mb-3">
                                <i class="bi bi-hexagon text-primary me-2"></i>
                                <strong>Shape:</strong> <span class="text-capitalize">${c.shape}</span>
                            </div>
                            <div class="mb-3">
                                <i class="bi bi-shield-check text-primary me-2"></i>
                                <strong>Strength:</strong> <span class="badge bg-info">${c.strength}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Physical Metrics Column -->
                    <div class="col-md-3">
                        <div class="spec-group">
                            <h6 class="text-muted mb-3" style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">âš–ï¸ Physical Metrics</h6>
                            <div class="mb-3">
                                <i class="bi bi-arrow-down-up text-success me-2"></i>
                                <strong>Package Weight:</strong><br>
                                <span class="fs-5 fw-bold text-success">${c.weight_measured ? c.weight_measured + 'g' : 'Not specified'}</span>
                            </div>
                            <div class="mb-3">
                                <i class="bi bi-box text-success me-2"></i>
                                <strong>Weight Capacity:</strong><br>
                                <span class="fs-5 fw-bold text-success">${c.weight_capacity ? c.weight_capacity + 'g' : 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Environmental Metrics Column -->
                    <div class="col-md-3">
                        <div class="spec-group">
                            <h6 class="text-muted mb-3" style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">â™»ï¸ Environmental</h6>
                            <div class="mb-3">
                                <i class="bi bi-recycle text-success me-2"></i>
                                <strong>Recyclability:</strong><br>
                                <div class="progress mt-2" style="height: 25px;">
                                    <div class="progress-bar bg-success" style="width: ${c.recyclability_percent}%; font-weight: 700;">${c.recyclability_percent}%</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <i class="bi bi-arrow-repeat text-info me-2"></i>
                                <strong>Recycling Type:</strong><br>
                                <span class="badge bg-info">${c.recycling || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost & Impact Column -->
                    <div class="col-md-3">
                        <div class="text-center p-4" style="background: #ffffff; border-radius: 12px; border: 2px solid var(--burlywood); box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <div class="mb-3">
                                <div class="text-muted mb-1" style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">PREDICTED COST</div>
                                <div class="display-6 fw-bold" style="color: var(--charcoal);">â‚¹${(c.total_cost || c.cost) ? parseFloat(c.total_cost || c.cost).toFixed(2) : '0.00'}</div>
                            </div>
                            <hr style="border-color: #dee2e6; opacity: 0.5;">
                            <div>
                                <div class="text-muted mb-1" style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">PREDICTED COâ‚‚ SCORE</div>
                                <div class="h3 fw-bold" style="color: var(--asparagus);">${c.co2 ? parseFloat(c.co2).toFixed(2) : '0.00'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Alternatives Table -->
        <div class="card mb-4 fade-in" style="border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
            <div class="card-header" style="background: linear-gradient(135deg, var(--asparagus) 0%, #7daf6d 100%); color: white; border: none; padding: 1.5rem 2rem;">
                <h4 class="mb-1 fw-bold"><i class="bi bi-list-check"></i> All Sustainable Alternatives</h4>
                <small class="opacity-75">Ranked by overall improvement â€¢ Showing all ${r.length} options</small>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" style="border-collapse: separate; border-spacing: 0;">
                        <thead style="background: var(--misty-grey); position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Rank</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Material</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Shape</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Strength</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Cost</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Cost Change</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">COâ‚‚ Score</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">COâ‚‚ Change</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    r.forEach((rec, i) => {
        const rankBadge = i === 0 ? 
            '<span class="badge bg-warning text-dark" style="padding: 0.5rem 0.8rem; font-size: 0.9rem; font-weight: 600;">#1</span>' :
            `<span class="badge bg-secondary" style="padding: 0.5rem 0.8rem; font-size: 0.9rem;">#${i+1}</span>`;
        
        const savingsClass = rec.cost_savings > 0 ? 'text-success' : 'text-danger';
        const savingsIcon = rec.cost_savings > 0 ? 'â†“' : 'â†‘';
        
        const co2Class = rec.co2_reduction > 0 ? 'text-success' : 'text-danger';
        const co2Icon = rec.co2_reduction > 0 ? 'â†“' : 'â†‘';
        
        const rowStyle = i === 0 ? 'background: #f8f9fa;' : '';
        
        html += `
            <tr style="${rowStyle}">
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">${rankBadge}</td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="text-capitalize">${rec.material}</span>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;" class="text-capitalize">${rec.shape}</td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">${rec.strength}</td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="fw-semibold">â‚¹${formatValue(rec.predicted_cost, '')}</span>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="${savingsClass} fw-semibold">${savingsIcon} â‚¹${Math.abs(rec.cost_savings).toFixed(2)}</span>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="fw-semibold">${formatValue(rec.predicted_co2, '')}</span>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="${co2Class} fw-semibold">${co2Icon} ${Math.abs(rec.co2_reduction).toFixed(2)}</span>
                </td>
            </tr>
        `;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-center bg-light" style="padding: 1rem; border-top: 2px solid var(--burlywood);">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    All costs and COâ‚‚ scores are ML-predicted values based on your input specifications
                </small>
            </div>
        </div>

        <!-- Comparison Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card fade-in" style="border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div class="card-header" style="background: linear-gradient(135deg, #fff 0%, #f0fff4 100%); border: none; padding: 1.5rem 2rem; border-bottom: 3px solid var(--asparagus);">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-bar-chart-fill text-success"></i> Cost Comparison Analysis</h5>
                        <small class="text-muted">Lower is better â€¢ Visual comparison across alternatives</small>
                    </div>
                    <div class="card-body" style="padding: 1.5rem;">
                        <canvas id="recCostChart" height="280"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card fade-in" style="border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div class="card-header" style="background: linear-gradient(135deg, #fff 0%, #f0f9ff 100%); border: none; padding: 1.5rem 2rem; border-bottom: 3px solid var(--charcoal);">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-cloud-fill text-primary"></i> COâ‚‚ Impact Comparison</h5>
                        <small class="text-muted">Lower is better â€¢ Environmental impact analysis</small>
                    </div>
                    <div class="card-body" style="padding: 1.5rem;">
                        <canvas id="recCO2Chart" height="280"></canvas>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('recResults').innerHTML = html;
    document.getElementById('recResults').classList.remove('hidden');
    
    // Render charts with correct data
    setTimeout(() => renderRecCharts(chartData), 100);
}

// FIX #3: Render comparison charts in recommendation section - SORTED VERTICAL BARS
function renderRecCharts(data) {
    const costCtx = document.getElementById('recCostChart');
    const co2Ctx = document.getElementById('recCO2Chart');
    
    if (!costCtx || !co2Ctx) return;
    
    // Destroy existing charts if any
    if (charts.recCost) charts.recCost.destroy();
    if (charts.recCO2) charts.recCO2.destroy();
    
    // Professional industrial color palette (Tableau-style)
    const industrialColors = [
        '#1F77B4',  // Professional Blue
        '#FF7F0E',  // Professional Orange
        '#2CA02C',  // Professional Green
        '#D62728',  // Professional Red
        '#9467BD',  // Professional Purple
        '#8C564B',  // Professional Brown
        '#E377C2',  // Professional Pink
        '#17BECF'   // Professional Cyan
    ];
    
    const currentColor = '#525252';  // Professional Gray for baseline
    
    // ============================================
    // PREPARE SORTED DATA FOR COST CHART
    // ============================================
    // Create array of objects with label, cost, and original index
    const costData = data.labels.map((label, i) => ({
        label: label,
        cost: data.costs[i],
        co2: data.co2s[i],
        isCurrent: i === 0,
        originalIndex: i
    }));
    
    // Sort by cost (ascending - lowest cost first)
    const sortedByCost = [...costData].sort((a, b) => a.cost - b.cost);
    
    // Extract sorted labels and values for cost chart
    const costLabels = sortedByCost.map(item => item.label);
    const costValues = sortedByCost.map(item => item.cost);
    const costColors = sortedByCost.map((item) => 
        item.isCurrent ? currentColor : industrialColors[sortedByCost.indexOf(item) % industrialColors.length]
    );
    
    // ============================================
    // PREPARE SORTED DATA FOR CO2 CHART
    // ============================================
    // Sort by CO2 (ascending - lowest CO2 first)
    const sortedByCO2 = [...costData].sort((a, b) => a.co2 - b.co2);
    
    // Extract sorted labels and values for CO2 chart
    const co2Labels = sortedByCO2.map(item => item.label);
    const co2Values = sortedByCO2.map(item => item.co2);
    const co2Colors = sortedByCO2.map((item) => 
        item.isCurrent ? currentColor : industrialColors[sortedByCO2.indexOf(item) % industrialColors.length]
    );
    
    // ============================================
    // COST CHART - SORTED VERTICAL BARS
    // ============================================
    charts.recCost = new Chart(costCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: costLabels,
            datasets: [{
                label: 'Cost (â‚¹)',
                data: costValues,
                backgroundColor: costColors,
                borderWidth: 0,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: { 
                    display: false 
                },
                tooltip: {
                    backgroundColor: '#1F2937',
                    padding: 14,
                    cornerRadius: 6,
                    titleFont: { size: 14, weight: '600', family: 'Inter' },
                    bodyFont: { size: 13, family: 'Inter' },
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    displayColors: true,
                    boxWidth: 12,
                    boxHeight: 12,
                    callbacks: {
                        label: (context) => `Cost: â‚¹${context.parsed.y.toFixed(2)}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: 'Cost (â‚¹)',
                        font: { size: 12, weight: '600', family: 'Inter' },
                        color: '#374151',
                        padding: { top: 0, bottom: 10 }
                    },
                    ticks: {
                        callback: (value) => 'â‚¹' + value.toFixed(0),
                        font: { size: 11, family: 'Inter' },
                        color: '#6B7280',
                        padding: 8
                    },
                    grid: { 
                        color: '#F3F4F6',
                        drawBorder: false,
                        lineWidth: 1
                    },
                    border: {
                        display: false
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { 
                        font: { size: 10, weight: '500', family: 'Inter' },
                        color: '#374151',
                        padding: 8,
                        maxRotation: 45,
                        minRotation: 45
                    },
                    border: {
                        display: false
                    }
                }
            }
        }
    });
    
    // ============================================
    // CO2 CHART - SORTED VERTICAL BARS
    // ============================================
    charts.recCO2 = new Chart(co2Ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: co2Labels,
            datasets: [{
                label: 'COâ‚‚ Impact Score',
                data: co2Values,
                backgroundColor: co2Colors,
                borderWidth: 0,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: { 
                    display: false 
                },
                tooltip: {
                    backgroundColor: '#1F2937',
                    padding: 14,
                    cornerRadius: 6,
                    titleFont: { size: 14, weight: '600', family: 'Inter' },
                    bodyFont: { size: 13, family: 'Inter' },
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    displayColors: true,
                    boxWidth: 12,
                    boxHeight: 12,
                    callbacks: {
                        label: (context) => `COâ‚‚ Score: ${context.parsed.y.toFixed(2)}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: 'COâ‚‚ Impact Score',
                        font: { size: 12, weight: '600', family: 'Inter' },
                        color: '#374151',
                        padding: { top: 0, bottom: 10 }
                    },
                    ticks: {
                        font: { size: 11, family: 'Inter' },
                        color: '#6B7280',
                        padding: 8
                    },
                    grid: { 
                        color: '#F3F4F6',
                        drawBorder: false,
                        lineWidth: 1
                    },
                    border: {
                        display: false
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { 
                        font: { size: 10, weight: '500', family: 'Inter' },
                        color: '#374151',
                        padding: 8,
                        maxRotation: 45,
                        minRotation: 45
                    },
                    border: {
                        display: false
                    }
                }
            }
        }
    });
}

// Render comparison charts - SORTED LOWEST TO HIGHEST
function renderCompCharts(comparisons) {
    const costCtx = document.getElementById('compCostChart');
    const co2Ctx = document.getElementById('compCO2Chart');
    
    if (!costCtx || !co2Ctx) return;
    
    // Destroy existing charts if any
    if (charts.compCost) charts.compCost.destroy();
    if (charts.compCO2) charts.compCO2.destroy();
    
    // Professional industrial colors
    const industrialColors = [
        '#1F77B4',  // Professional Blue
        '#FF7F0E',  // Professional Orange
        '#2CA02C',  // Professional Green
        '#D62728',  // Professional Red
        '#9467BD',  // Professional Purple
        '#8C564B',  // Professional Brown
        '#E377C2',  // Professional Pink
        '#17BECF'   // Professional Cyan
    ];
    
    // ============================================
    // SORT BY COST (ASCENDING - LOWEST FIRST)
    // ============================================
    const sortedByCost = [...comparisons].sort((a, b) => a.cost - b.cost);
    const costLabels = sortedByCost.map(c => c.material.toUpperCase());
    const costValues = sortedByCost.map(c => c.cost);
    const costColors = costValues.map((val, idx) => industrialColors[idx % industrialColors.length]);
    
    // ============================================
    // SORT BY CO2 (ASCENDING - LOWEST FIRST)
    // ============================================
    const sortedByCO2 = [...comparisons].sort((a, b) => a.co2 - b.co2);
    const co2Labels = sortedByCO2.map(c => c.material.toUpperCase());
    const co2Values = sortedByCO2.map(c => c.co2);
    const co2Colors = co2Values.map((val, idx) => industrialColors[idx % industrialColors.length]);
    
    // ============================================
    // COST CHART - SORTED VERTICAL BARS
    // ============================================
    charts.compCost = new Chart(costCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: costLabels,
            datasets: [{
                label: 'Predicted Cost (â‚¹)',
                data: costValues,
                backgroundColor: costColors,
                borderWidth: 0,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.8,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1F2937',
                    padding: 14,
                    cornerRadius: 6,
                    titleFont: { size: 14, weight: '600', family: 'Inter' },
                    bodyFont: { size: 13, family: 'Inter' },
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    callbacks: {
                        label: (context) => `Cost: â‚¹${context.parsed.y.toFixed(2)}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: 'Cost (â‚¹)',
                        font: { weight: '600', size: 12, family: 'Inter' },
                        color: '#374151',
                        padding: { top: 0, bottom: 10 }
                    },
                    grid: { 
                        color: '#F3F4F6',
                        drawBorder: false,
                        lineWidth: 1
                    },
                    ticks: {
                        callback: (value) => 'â‚¹' + value.toFixed(0),
                        color: '#6B7280',
                        font: { size: 11, family: 'Inter' },
                        padding: 8
                    },
                    border: {
                        display: false
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        color: '#374151',
                        font: { weight: '600', size: 11, family: 'Inter' },
                        padding: 8
                    },
                    border: {
                        display: false
                    }
                }
            }
        }
    });
    
    // ============================================
    // CO2 CHART - SORTED VERTICAL BARS
    // ============================================
    charts.compCO2 = new Chart(co2Ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: co2Labels,
            datasets: [{
                label: 'COâ‚‚ Impact Score',
                data: co2Values,
                backgroundColor: co2Colors,
                borderWidth: 0,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.8,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1F2937',
                    padding: 14,
                    cornerRadius: 6,
                    titleFont: { size: 14, weight: '600', family: 'Inter' },
                    bodyFont: { size: 13, family: 'Inter' },
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    callbacks: {
                        label: (context) => `COâ‚‚ Score: ${context.parsed.y.toFixed(2)}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: 'COâ‚‚ Impact Score',
                        font: { weight: '600', size: 12, family: 'Inter' },
                        color: '#374151',
                        padding: { top: 0, bottom: 10 }
                    },
                    grid: { 
                        color: '#F3F4F6',
                        drawBorder: false,
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#6B7280',
                        font: { size: 11, family: 'Inter' },
                        padding: 8
                    },
                    border: {
                        display: false
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        color: '#374151',
                        font: { weight: '600', size: 11, family: 'Inter' },
                        padding: 8
                    },
                    border: {
                        display: false
                    }
                }
            }
        }
    });
}

function displayComp(data, inputData) {
    const comparisons = data.comparisons;
    
    // Sort by cost (ascending)
    const sortedByPrice = [...comparisons].sort((a, b) => a.cost - b.cost);
    const cheapest = sortedByPrice[0];
    
    // Sort by CO2 (ascending)
    const sortedByCO2 = [...comparisons].sort((a, b) => a.co2 - b.co2);
    const greenest = sortedByCO2[0];
    
    // Find best overall (lowest cost + lowest CO2)
    const withScores = comparisons.map(c => ({
        ...c,
        overallScore: (c.cost / Math.max(...comparisons.map(x => x.cost))) + 
                      (c.co2 / Math.max(...comparisons.map(x => x.co2)))
    }));
    const bestOverall = withScores.sort((a, b) => a.overallScore - b.overallScore)[0];
    
    let html = `
        <!-- Key Insights Section -->
        <div class="card mt-4 mb-4 fade-in" style="border: none; border-radius: 20px; box-shadow: 0 4px 25px rgba(105, 153, 93, 0.15); overflow: hidden;">
            <div class="card-header" style="background: linear-gradient(135deg, var(--asparagus) 0%, #7daf6d 100%); color: white; padding: 1.5rem 2rem; border: none;">
                <h4 class="mb-1 fw-bold"><i class="bi bi-lightbulb-fill me-2"></i>Key Insights & Recommendations</h4>
                <small class="opacity-75">Analysis of ${comparisons.length} material alternatives</small>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="text-center p-4" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border-radius: 16px; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);">
                            <i class="bi bi-trophy-fill" style="font-size: 3rem; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);"></i>
                            <h5 class="fw-bold mt-3 mb-2" style="color: #333;">Best Overall</h5>
                            <h3 class="fw-bold text-uppercase mb-2" style="color: #333;">${bestOverall.material}</h3>
                            <p class="mb-1" style="color: #555;"><strong>Cost:</strong> â‚¹${bestOverall.cost.toFixed(2)}</p>
                            <p class="mb-0" style="color: #555;"><strong>COâ‚‚:</strong> ${bestOverall.co2.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-4" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 16px; color: white; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                            <i class="bi bi-currency-rupee" style="font-size: 3rem;"></i>
                            <h5 class="fw-bold mt-3 mb-2">Most Economical</h5>
                            <h3 class="fw-bold text-uppercase mb-2">${cheapest.material}</h3>
                            <p class="mb-1"><strong>Cost:</strong> â‚¹${cheapest.cost.toFixed(2)}</p>
                            <p class="mb-0"><strong>Savings vs Highest:</strong> â‚¹${(Math.max(...comparisons.map(c => c.cost)) - cheapest.cost).toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-4" style="background: linear-gradient(135deg, #198754 0%, #20c997 100%); border-radius: 16px; color: white; box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);">
                            <i class="bi bi-tree-fill" style="font-size: 3rem;"></i>
                            <h5 class="fw-bold mt-3 mb-2">Most Sustainable</h5>
                            <h3 class="fw-bold text-uppercase mb-2">${greenest.material}</h3>
                            <p class="mb-1"><strong>COâ‚‚ Score:</strong> ${greenest.co2.toFixed(2)}</p>
                            <p class="mb-0"><strong>Reduction vs Highest:</strong> ${(Math.max(...comparisons.map(c => c.co2)) - greenest.co2).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Comparison Table -->
        <div class="card mb-4 fade-in" style="border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
            <div class="card-header" style="background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-bottom: 3px solid var(--burlywood); padding: 1.5rem 2rem;">
                <h4 class="mb-1 fw-bold"><i class="bi bi-table me-2"></i>Side-by-Side Comparison</h4>
                <small class="text-muted">Detailed metrics for ${comparisons.length} materials â€¢ Shape: ${inputData.shape} â€¢ Weight: ${inputData.weight_measured}g</small>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" style="border-collapse: separate; border-spacing: 0;">
                        <thead style="background: var(--misty-grey); position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Material</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Predicted Cost</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Cost Rank</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">COâ‚‚ Score</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Environmental Rank</th>
                                <th style="padding: 1rem 1.5rem; border: none; font-weight: 700;">Overall Rating</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Sort comparisons by overall score for display
    const displayComparisons = [...withScores].sort((a, b) => a.overallScore - b.overallScore);
    
    displayComparisons.forEach((c, idx) => {
        const costRank = sortedByPrice.findIndex(x => x.material === c.material) + 1;
        const co2Rank = sortedByCO2.findIndex(x => x.material === c.material) + 1;
        const isBest = c.material === bestOverall.material;
        const rowStyle = isBest ? 'background: linear-gradient(to right, rgba(255, 215, 0, 0.15) 0%, transparent 100%);' : '';
        
        // Calculate star rating (5 stars max, inverted from overall score)
        const minScore = Math.min(...withScores.map(x => x.overallScore));
        const maxScore = Math.max(...withScores.map(x => x.overallScore));
        const scoreRange = maxScore - minScore;

        // Normalize: best (min) score = 5 stars, worst (max) score = 1 star
        let stars;
        if (scoreRange === 0) {
            stars = 5; // All same score = all get 5 stars
        } else {
            const normalizedScore = 1 - ((c.overallScore - minScore) / scoreRange);
            stars = Math.max(1, Math.round(normalizedScore * 5)); // Ensure at least 1 star
        }
        const starDisplay = 'â­'.repeat(stars) + 'â˜†'.repeat(5 - stars);
                
        html += `
            <tr style="${rowStyle}">
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-bold text-uppercase" style="font-size: 1.1rem;">${c.material}</span>
                        ${isBest ? '<span class="badge bg-warning text-dark ms-2"><i class="bi bi-trophy-fill"></i> BEST</span>' : ''}
                    </div>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="fw-bold fs-5" style="color: var(--charcoal);">â‚¹${c.cost.toFixed(2)}</span>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="badge ${costRank === 1 ? 'bg-success' : costRank === comparisons.length ? 'bg-danger' : 'bg-secondary'}" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        #${costRank} ${costRank === 1 ? 'Cheapest' : ''}
                    </span>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="fw-bold fs-5" style="color: var(--asparagus);">${c.co2.toFixed(2)}</span>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span class="badge ${co2Rank === 1 ? 'bg-success' : co2Rank === comparisons.length ? 'bg-danger' : 'bg-secondary'}" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        #${co2Rank} ${co2Rank === 1 ? 'Greenest' : ''}
                    </span>
                </td>
                <td style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef;">
                    <span style="font-size: 1.3rem;">${starDisplay}</span>
                </td>
            </tr>
        `;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Visual Comparison Charts -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card fade-in" style="border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div class="card-header" style="background: linear-gradient(135deg, #fff 0%, #fff7ed 100%); border-bottom: 3px solid var(--melon); padding: 1.5rem 2rem;">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-bar-chart-fill text-warning"></i> Cost Comparison</h5>
                        <small class="text-muted">Lower values indicate better pricing</small>
                    </div>
                    <div class="card-body" style="padding: 2rem;">
                        <canvas id="compCostChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card fade-in" style="border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div class="card-header" style="background: linear-gradient(135deg, #fff 0%, #f0fff4 100%); border-bottom: 3px solid var(--asparagus); padding: 1.5rem 2rem;">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-cloud-fill text-success"></i> Environmental Impact</h5>
                        <small class="text-muted">Lower COâ‚‚ scores are more sustainable</small>
                    </div>
                    <div class="card-body" style="padding: 2rem;">
                        <canvas id="compCO2Chart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Material Properties Breakdown -->
        <div class="card fade-in" style="border: none; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
            <div class="card-header" style="background: var(--white); border-bottom: 1px solid #E5E7EB; padding: 1.25rem 1.5rem;">
                <h4 class="mb-0 fw-semibold" style="color: var(--charcoal);"><i class="bi bi-info-circle-fill me-2" style="color: var(--asparagus);"></i>Material Insights</h4>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
    `;
    
    // Add material insight cards
    const materialInsights = {
        'aluminium': { icon: 'bi-box', strength: 'High', recyclability: 'Excellent', note: 'Lightweight and infinitely recyclable' },
        'cardboard': { icon: 'bi-box-seam', strength: 'Medium', recyclability: 'Good', note: 'Biodegradable and cost-effective' },
        'glass': { icon: 'bi-cup-straw', strength: 'High', recyclability: 'Excellent', note: 'Premium feel, heavy weight' },
        'metal': { icon: 'bi-gear', strength: 'Very High', recyclability: 'Excellent', note: 'Durable but higher cost' },
        'paper': { icon: 'bi-file-earmark-text', strength: 'Low', recyclability: 'Good', note: 'Economical but less protective' },
        'plastic': { icon: 'bi-droplet', strength: 'Medium', recyclability: 'Variable', note: 'Versatile but environmental concerns' },
        'plastic 7': { icon: 'bi-recycle', strength: 'Medium', recyclability: 'Low', note: 'Mixed plastics, harder to recycle' },
        'steel': { icon: 'bi-nut', strength: 'Very High', recyclability: 'Excellent', note: 'Strong but heavy and costly' }
    };
    
    comparisons.forEach(c => {
        const insight = materialInsights[c.material] || materialInsights['unknown'];
        html += `
            <div class="col-md-${12 / Math.min(comparisons.length, 4)}">
                <div class="text-center p-3" style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 12px; transition: all 0.2s ease;">
                    <i class="bi ${insight.icon}" style="font-size: 2.5rem; color: var(--asparagus); margin-bottom: 0.5rem;"></i>
                    <h6 class="fw-bold text-uppercase mb-2" style="color: var(--charcoal);">${c.material}</h6>
                    <p class="mb-1 small" style="color: #374151;"><strong>Strength:</strong> ${insight.strength}</p>
                    <p class="mb-1 small" style="color: #374151;"><strong>Recyclability:</strong> ${insight.recyclability}</p>
                    <p class="mb-0 small text-muted">${insight.note}</p>
                </div>
            </div>
        `;
    });
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('compResults').innerHTML = html;
    document.getElementById('compResults').classList.remove('hidden');
    
    // Render comparison charts
    setTimeout(() => renderCompCharts(comparisons), 100);
}

function displayBulk(data) {
    bulkResultsData = data.results || [];
    
    const successCount = bulkResultsData.filter(r => r.status === 'success').length;
    const errorCount = bulkResultsData.filter(r => r.status === 'error').length;
    
    let html = `
        <div class="alert ${errorCount > 0 ? 'alert-warning' : 'alert-success'} fade-in" style="border-radius: 12px; border: 2px solid ${errorCount > 0 ? '#ffc107' : '#28a745'};">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">
                        <i class="bi ${errorCount > 0 ? 'bi-exclamation-circle-fill' : 'bi-check-circle-fill'} me-2"></i>
                        Processing Complete
                    </h5>
                    <p class="mb-0">
                        <strong>Total:</strong> ${data.total_rows} | 
                        <strong class="text-success">Success:</strong> ${successCount} | 
                        <strong class="text-danger">Failed:</strong> ${errorCount}
                    </p>
                </div>
            </div>
        </div>
        
        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-hover mb-0" style="border: 1px solid #e9ecef;">
                <thead style="background: var(--misty-grey); position: sticky; top: 0; z-index: 10;">
                    <tr>
                        <th style="padding: 1rem; border: none; font-weight: 700; white-space: nowrap;">Row</th>
                        <th style="padding: 1rem; border: none; font-weight: 700; white-space: nowrap;">Material</th>
                        <th style="padding: 1rem; border: none; font-weight: 700; white-space: nowrap;">Predicted Cost</th>
                        <th style="padding: 1rem; border: none; font-weight: 700; white-space: nowrap;">Predicted COâ‚‚</th>
                        <th style="padding: 1rem; border: none; font-weight: 700; white-space: nowrap;">Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    bulkResultsData.forEach(r => {
        const isError = r.status === 'error';
        const rowClass = isError ? 'table-danger' : '';
        
        html += `
            <tr class="${rowClass}">
                <td style="padding: 1rem; border-top: 1px solid #e9ecef;">${r.row || '-'}</td>
                <td style="padding: 1rem; border-top: 1px solid #e9ecef;">
                    <span class="text-capitalize fw-semibold">${r.material || '-'}</span>
                </td>
                <td style="padding: 1rem; border-top: 1px solid #e9ecef;">
                    ${isError ? '<span class="text-muted">-</span>' : `<span class="fw-bold text-success">â‚¹${parseFloat(r.cost || 0).toFixed(2)}</span>`}
                </td>
                <td style="padding: 1rem; border-top: 1px solid #e9ecef;">
                    ${isError ? '<span class="text-muted">-</span>' : `<span class="fw-bold" style="color: var(--asparagus);">${parseFloat(r.co2 || 0).toFixed(2)}</span>`}
                </td>
                <td style="padding: 1rem; border-top: 1px solid #e9ecef;">
                    <span class="badge ${r.status === 'success' ? 'bg-success' : 'bg-danger'}" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                        ${r.status === 'success' ? 'âœ“ Success' : 'âœ— Failed'}
                    </span>
                    ${r.error ? `<br><small class="text-danger mt-1 d-block">${r.error}</small>` : ''}
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('bulkResults').innerHTML = html;
    document.getElementById('bulkResults').classList.remove('hidden');
    document.getElementById('bulkDownload').classList.remove('hidden');
}

function toggleHistoryDetails(id) {
    const detailsRow = document.getElementById(`details-${id}`);
    const chevron = document.getElementById(`chevron-${id}`);
    
    if (!detailsRow || !chevron) {
        console.error(`Elements not found for ID: ${id}`);
        return;
    }
    
    const isVisible = detailsRow.style.display !== 'none';
    
    if (isVisible) {
        // Hide details
        detailsRow.style.display = 'none';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-right');
        chevron.style.transform = 'rotate(0deg)';
    } else {
        // Show details
        detailsRow.style.display = 'table-row';
        chevron.classList.remove('bi-chevron-right');
        chevron.classList.add('bi-chevron-down');
        chevron.style.transform = 'rotate(90deg)';
    }
}

// ============================================================================
// FIXED HISTORY LOADING FUNCTION
// ============================================================================
async function loadHistory() {
    const historyList = document.getElementById('historyList');
    
    historyList.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-success mb-3"></div>
            <p class="text-muted">Loading your history...</p>
        </div>
    `;
    
    try {
        const res = await fetch(`${API}/history`, {
            credentials: 'include'
        });
        
        if (handleAuthError(res)) return;
        
        const data = await res.json();
        
        if (!data.history || data.history.length === 0) {
            historyList.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">No recommendations yet. Start by getting some recommendations!</p>
                </div>
            `;
            globalHistoryData = [];
            return;
        }
        
        // Store data globally for export
        globalHistoryData = data.history;
        
        let html = `
            <!-- Filter Bar -->
            <div style="padding: 1.25rem 1.5rem; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-funnel-fill" style="color: var(--asparagus);"></i>
                            <select class="form-select form-select-sm" id="historyFilter" onchange="filterHistory()" style="width: auto; border-radius: 6px;">
                                <option value="all">All Records</option>
                                <option value="savings">Cost Savings Only</option>
                                <option value="reduction">COâ‚‚ Reduction Only</option>
                                <option value="recent">Last 30 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-sort-down" style="color: var(--asparagus);"></i>
                            <select class="form-select form-select-sm" id="historySort" onchange="sortHistory()" style="width: auto; border-radius: 6px;">
                                <option value="date_desc">Newest First</option>
                                <option value="date_asc">Oldest First</option>
                                <option value="cost_desc">Highest Cost Savings</option>
                                <option value="co2_desc">Highest COâ‚‚ Reduction</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="text-end">
                            <span class="badge bg-light text-dark border px-3 py-2">
                                <i class="bi bi-bar-chart-fill me-1"></i>
                                <strong>${data.history.length}</strong> Total Records
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- History Table -->
            <div style="overflow-x: auto; overflow-y: auto; max-height: 70vh;">
                <table class="table table-hover mb-0" style="background: white; font-size: 0.85rem;">
                    <thead style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <tr>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 130px; font-size: 0.8rem;">
                                <i class="bi bi-calendar-event me-1"></i>Date & Time
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 115px; font-size: 0.8rem;">
                                <i class="bi bi-box-seam me-1"></i>Material
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 95px; font-size: 0.8rem;">
                                Shape
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 85px; font-size: 0.8rem;">
                                Strength
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 130px; font-size: 0.8rem;">
                                <i class="bi bi-basket3 me-1"></i>Food Group
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 95px; font-size: 0.8rem;">
                                Prod. Qty (g)
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 95px; font-size: 0.8rem;">
                                Pkg. Wt (g)
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 90px; font-size: 0.8rem;">
                                Recycle %
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 100px; text-align: right; font-size: 0.8rem;">
                                <i class="bi bi-currency-rupee me-1"></i>Curr. Cost
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 100px; text-align: right; font-size: 0.8rem;">
                                <i class="bi bi-cloud-fill me-1"></i>Curr. COâ‚‚
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 165px; font-size: 0.8rem;">
                                <i class="bi bi-trophy me-1"></i>Best Alternative
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 110px; text-align: center; font-size: 0.8rem;">
                                <i class="bi bi-arrow-down-circle me-1"></i>Cost Impact
                            </th>
                            <th style="padding: 0.75rem; border: none; font-weight: 700; white-space: nowrap; min-width: 110px; text-align: center; font-size: 0.8rem;">
                                <i class="bi bi-arrow-down-circle me-1"></i>COâ‚‚ Impact
                            </th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
        `;
        
        data.history.forEach((item, index) => {
            const date = new Date(item.created_at).toLocaleString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            const costSavings = item.total_cost_savings || 0;
            const co2Reduction = item.total_co2_reduction || 0;
            
            const costClass = costSavings >= 0 ? 'text-success' : 'text-danger';
            const costIcon = costSavings >= 0 ? 'â†“' : 'â†‘';
            const costBg = costSavings >= 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(220, 38, 38, 0.1)';
            
            const co2Class = co2Reduction >= 0 ? 'text-success' : 'text-danger';
            const co2Icon = co2Reduction >= 0 ? 'â†“' : 'â†‘';
            const co2Bg = co2Reduction >= 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(220, 38, 38, 0.1)';
            
            // Format food group for display
            const foodGroup = item.product.food_group || 'N/A';
            const foodGroupDisplay = foodGroup.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            
            // Get product quantity - check multiple possible locations
            const productQty = item.product.product_quantity || 
                              item.product_quantity || 
                              (item.product.details && item.product.details.product_quantity) || 
                              'N/A';
            
            html += `
                <tr class="history-row" 
                    data-cost-savings="${costSavings}"
                    data-co2-reduction="${co2Reduction}"
                    data-date="${item.created_at}"
                    style="border-bottom: 1px solid #f3f4f6; transition: background 0.2s;"
                    onmouseover="this.style.background='#f9fafb'" 
                    onmouseout="this.style.background='white'">
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <div class="fw-semibold" style="color: #1f2937; font-size: 0.8rem;">${date}</div>
                        <small class="text-muted" style="font-size: 0.7rem;">ID: REC-${item.id}</small>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <span class="badge bg-primary text-uppercase" style="padding: 0.35rem 0.6rem; font-size: 0.75rem;">${item.product.material}</span>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <span class="text-capitalize" style="font-size: 0.8rem;">${item.product.shape}</span>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <span class="badge bg-info" style="padding: 0.35rem 0.6rem; font-size: 0.75rem;">${item.product.strength}</span>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <span class="text-capitalize"style="font-size: 0.8rem; color: #1f2937; font-weight: 500;">${foodGroupDisplay}</span>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <span class="fw-semibold" style="font-size: 0.85rem;">${productQty}${productQty !== 'N/A' ? 'g' : ''}</span>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <div style="font-size: 0.85rem; font-weight: 600;">${item.product.weight_measured}g</div>
                        <small class="text-muted" style="font-size: 0.7rem;">Cap: ${item.product.weight_capacity}g</small>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <div class="progress" style="height: 20px; background: #e9ecef;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: ${item.product.recyclability_percent}%; font-size: 0.7rem; font-weight: 600;"
                                 aria-valuenow="${item.product.recyclability_percent}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                ${item.product.recyclability_percent}%
                            </div>
                        </div>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6; text-align: right;">
                        <div class="fw-bold" style="font-size: 0.95rem; color: #1f2937;">â‚¹${item.current.cost.toFixed(2)}</div>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6; text-align: right;">
                        <div class="fw-bold" style="font-size: 0.95rem; color: #1f2937;">${item.current.co2.toFixed(2)}</div>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <div class="mb-1">
                            <span class="badge text-uppercase" style="background: var(--asparagus); color: white; padding: 0.35rem 0.6rem; font-size: 0.75rem;">
                                ${item.best_alternative.material}
                            </span>
                            <span class="badge bg-light text-dark text-capitalize ms-1" style="padding: 0.35rem 0.5rem; font-size: 0.7rem;">
                                ${item.best_alternative.shape}
                            </span>
                        </div>
                        <small class="text-muted" style="font-size: 0.7rem;">
                            <strong>Cost:</strong> â‚¹${item.best_alternative.predicted_cost.toFixed(2)} â€¢ 
                            <strong>COâ‚‚:</strong> ${item.best_alternative.predicted_co2.toFixed(2)}
                        </small>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <div class="d-flex justify-content-center">
                            <div class="${costClass} fw-bold text-center" style="background: ${costBg}; padding: 0.5rem; border-radius: 6px; font-size: 0.95rem; min-width: 90px; width: 90px;">
                                ${costIcon} â‚¹${Math.abs(costSavings).toFixed(2)}
                            </div>
                        </div>
                    </td>
                    
                    <td style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                        <div class="d-flex justify-content-center">
                            <div class="${co2Class} fw-bold text-center" style="background: ${co2Bg}; padding: 0.5rem; border-radius: 6px; font-size: 0.95rem; min-width: 90px; width: 90px;">
                                ${co2Icon} ${Math.abs(co2Reduction).toFixed(2)}
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
            
            <div style="padding: 0.875rem; background: #f8f9fa; border-top: 1px solid #e9ecef; text-align: center;">
                <small class="text-muted" style="font-size: 0.8rem;">
                    <i class="bi bi-info-circle me-1"></i>
                    All costs and COâ‚‚ scores are ML-predicted values â€¢ Showing best alternative only
                </small>
            </div>
        `;
        
        historyList.innerHTML = html;
        
    } catch (e) {
        console.error('History error:', e);
        historyList.innerHTML = `
            <div class="alert alert-danger m-4">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Failed to load history. Please try again.
            </div>
        `;
        globalHistoryData = [];
    }
}

// ============================================================================
// FILTER HISTORY FUNCTION - FIXED
// ============================================================================
function filterHistory() {
    const filter = document.getElementById('historyFilter').value;
    const rows = document.querySelectorAll('.history-row');
    
    rows.forEach(row => {
        const costSavings = parseFloat(row.getAttribute('data-cost-savings'));
        const co2Reduction = parseFloat(row.getAttribute('data-co2-reduction'));
        const date = new Date(row.getAttribute('data-date'));
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        let show = true;
        
        switch(filter) {
            case 'savings':
                show = costSavings > 0;
                break;
            case 'reduction':
                show = co2Reduction > 0;
                break;
            case 'recent':
                show = date >= thirtyDaysAgo;
                break;
            case 'all':
            default:
                show = true;
                break;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// ============================================================================
// SORT HISTORY FUNCTION - FIXED
// ============================================================================
function sortHistory() {
    const sortBy = document.getElementById('historySort').value;
    const tbody = document.getElementById('historyTableBody');
    const rows = Array.from(tbody.querySelectorAll('.history-row'));
    
    rows.sort((a, b) => {
        const aData = {
            cost: parseFloat(a.getAttribute('data-cost-savings')),
            co2: parseFloat(a.getAttribute('data-co2-reduction')),
            date: new Date(a.getAttribute('data-date'))
        };
        const bData = {
            cost: parseFloat(b.getAttribute('data-cost-savings')),
            co2: parseFloat(b.getAttribute('data-co2-reduction')),
            date: new Date(b.getAttribute('data-date'))
        };
        
        switch(sortBy) {
            case 'date_desc':
                return bData.date - aData.date;
            case 'date_asc':
                return aData.date - bData.date;
            case 'cost_desc':
                return bData.cost - aData.cost;
            case 'co2_desc':
                return bData.co2 - aData.co2;
            default:
                return 0;
        }
    });
    
    // Clear and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => {
        tbody.appendChild(row);
    });
}

async function loadCharts() {
    const ctx1 = document.getElementById('costChart');
    const ctx2 = document.getElementById('co2Chart');
    const ctx3 = document.getElementById('materialDistChart');
    
    if (!ctx1 || !ctx2 || !ctx3) {
        console.error('Chart canvases not found');
        return;
    }
    
    // Destroy existing charts
    if (charts.cost) charts.cost.destroy();
    if (charts.co2) charts.co2.destroy();
    if (charts.materialDist) charts.materialDist.destroy();
    
    try {
        const res = await fetch(`${API}/analytics/user`, {
            credentials: 'include'
        });
        
        if (handleAuthError(res)) return;
        
        const data = await res.json();
        
        // ============================================================================
        // USE REAL HISTORY DATA - NO MORE FALLBACKS
        // ============================================================================
        const historyData = data.history || [];
        
        if (historyData.length === 0) {
            // Show "No Data" message
            showNoDataCharts(ctx1, ctx2, ctx3);
            return;
        }
        
        // ============================================================================
        // COST & CO2 TREND CHARTS - Use actual history
        // ============================================================================
        // Take last 10 recommendations, ordered chronologically
        const recentData = historyData.slice(-10);
        
        const labels = recentData.map((item, i) => {
            const date = new Date(item.created_at);
            return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
        });
        
        const costData = recentData.map(r => Math.abs(parseFloat(r.cost_savings) || 0));
        const co2Data = recentData.map(r => Math.abs(parseFloat(r.co2_reduction) || 0));
        
        // ============================================================================
        // CALCULATE REAL ANALYTICS METRICS
        // ============================================================================
        const totalCost = costData.reduce((a, b) => a + b, 0);
        const avgCost = totalCost / costData.length;
        const totalCO2 = co2Data.reduce((a, b) => a + b, 0);
        const avgCO2 = totalCO2 / co2Data.length;
        const bestSaving = Math.max(...costData);
        const bestSavingIndex = costData.indexOf(bestSaving);
        const bestCO2Index = co2Data.indexOf(Math.max(...co2Data));
        
        // Calculate this month's recommendations
        const now = new Date();
        const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const thisMonthCount = historyData.filter(item => {
            const itemDate = new Date(item.created_at);
            return itemDate >= thisMonthStart;
        }).length;
        
        // ============================================================================
        // UPDATE SUMMARY CARDS WITH REAL DATA
        // ============================================================================
        document.getElementById('analyticsAvgSavings').textContent = `â‚¹${avgCost.toFixed(2)}`;
        document.getElementById('analyticsAvgCO2').textContent = avgCO2.toFixed(2);
        document.getElementById('analyticsThisMonth').textContent = thisMonthCount;
        document.getElementById('analyticsBestSaving').textContent = `â‚¹${bestSaving.toFixed(2)}`;
        
        // ============================================================================
        // UPDATE CHART FOOTERS
        // ============================================================================
        document.getElementById('costChartTotal').textContent = `â‚¹${totalCost.toFixed(2)}`;
        document.getElementById('costChartBest').textContent = labels[bestSavingIndex];
        document.getElementById('co2ChartTotal').textContent = totalCO2.toFixed(2);
        document.getElementById('co2ChartBest').textContent = labels[bestCO2Index];
        
        // ============================================================================
        // UPDATE PERFORMANCE MATRIX
        // ============================================================================
        document.getElementById('pmCostThis').textContent = `â‚¹${avgCost.toFixed(2)}`;
        document.getElementById('pmCO2This').textContent = avgCO2.toFixed(2);
        document.getElementById('pmRecsThis').textContent = thisMonthCount;
        
        // ============================================================================
        // COST SAVINGS TREND CHART
        // ============================================================================
        charts.cost = new Chart(ctx1.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cost Savings (â‚¹)',
                    data: costData,
                    borderColor: '#1F77B4',
                    backgroundColor: 'rgba(31, 119, 180, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2.5,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#1F77B4',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: '600', family: 'Inter' },
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        padding: 14,
                        cornerRadius: 6,
                        titleFont: { size: 14, weight: '600', family: 'Inter' },
                        bodyFont: { size: 13, family: 'Inter' },
                        callbacks: {
                            label: (context) => `Savings: â‚¹${context.parsed.y.toFixed(2)}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: 'Cost Savings (â‚¹)',
                            font: { size: 12, weight: '600', family: 'Inter' },
                            color: '#374151'
                        },
                        ticks: {
                            callback: (value) => 'â‚¹' + value.toFixed(0),
                            font: { size: 11, family: 'Inter' },
                            color: '#6B7280'
                        },
                        grid: { 
                            color: '#F3F4F6',
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { size: 11, weight: '500', family: 'Inter' },
                            color: '#374151'
                        }
                    }
                }
            }
        });

        // ============================================================================
        // CO2 REDUCTION TREND CHART
        // ============================================================================
        charts.co2 = new Chart(ctx2.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'COâ‚‚ Reduction',
                    data: co2Data,
                    borderColor: '#2CA02C',
                    backgroundColor: 'rgba(44, 160, 44, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2.5,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#2CA02C',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: '600', family: 'Inter' },
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        padding: 14,
                        cornerRadius: 6,
                        titleFont: { size: 14, weight: '600', family: 'Inter' },
                        bodyFont: { size: 13, family: 'Inter' },
                        callbacks: {
                            label: (context) => `COâ‚‚ Reduction: ${context.parsed.y.toFixed(2)}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: 'COâ‚‚ Impact Score',
                            font: { size: 12, weight: '600', family: 'Inter' },
                            color: '#374151'
                        },
                        ticks: {
                            font: { size: 11, family: 'Inter' },
                            color: '#6B7280'
                        },
                        grid: { 
                            color: '#F3F4F6',
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { size: 11, weight: '500', family: 'Inter' },
                            color: '#374151'
                        }
                    }
                }
            }
        });

        // ============================================================================
        // MATERIAL DISTRIBUTION PIE CHART - USE REAL DATA
        // ============================================================================
        const materialCounts = {};
        historyData.forEach(item => {
            // Try multiple possible locations for material data
            let material = 'Unknown';
            
            // Check product_details (JSONB field)
            if (item.product_details && item.product_details.material) {
                material = item.product_details.material;
            }
            // Fallback: check if product_details is a JSON string that needs parsing
            else if (typeof item.product_details === 'string') {
                try {
                    const parsed = JSON.parse(item.product_details);
                    material = parsed.material || 'Unknown';
                } catch (e) {
                    console.log('Could not parse product_details:', e);
                }
            }
            
            const materialKey = material.toLowerCase().trim();
            
            // Skip 'unknown' materials
            if (materialKey !== 'unknown' && materialKey !== '') {
                materialCounts[materialKey] = (materialCounts[materialKey] || 0) + 1;
            }
        });

        console.log('Material counts:', materialCounts); // Debug log
        
        // Sort by count and take top 5
        const sortedMaterials = Object.entries(materialCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        // If no materials found, show "No Data"
        if (sortedMaterials.length === 0) {
            charts.materialDist = new Chart(ctx3.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#E5E7EB'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        } else {
            // Format labels (capitalize first letter)
            const materialLabels = sortedMaterials.map(([mat, _]) => 
                mat.charAt(0).toUpperCase() + mat.slice(1)
            );
            const materialData = sortedMaterials.map(([_, count]) => count);
            
            // Professional color palette
            const materialColors = [
                '#1F77B4',  // Blue
                '#FF7F0E',  // Orange
                '#2CA02C',  // Green
                '#D62728',  // Red
                '#9467BD'   // Purple
            ];
            
            console.log('Material Distribution:', materialLabels, materialData); // Debug log
            
            charts.materialDist = new Chart(ctx3.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: materialLabels,
                    datasets: [{
                        data: materialData,
                        backgroundColor: materialColors.slice(0, materialLabels.length),
                        borderWidth: 2,
                        borderColor: '#fff',
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 11, family: 'Inter', weight: '600' },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1F2937',
                            padding: 12,
                            cornerRadius: 6,
                            titleFont: { size: 13, weight: '600', family: 'Inter' },
                            bodyFont: { size: 12, family: 'Inter' },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${percentage}% (${value} recommendations)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                }
            });
        }
        
    } catch (e) {
        console.error('Charts error:', e);
        showNoDataCharts(ctx1, ctx2, ctx3);
    }
}

// ============================================================================
// HELPER FUNCTION - Show "No Data" message in charts
// ============================================================================
function showNoDataCharts(ctx1, ctx2, ctx3) {
    const noDataMessage = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
        }
    };
    
    // Cost chart
    charts.cost = new Chart(ctx1.getContext('2d'), {
        type: 'line',
        data: {
            labels: ['No Data'],
            datasets: [{
                label: 'Cost Savings',
                data: [0],
                borderColor: '#E5E7EB',
                backgroundColor: '#F9FAFB'
            }]
        },
        options: noDataMessage
    });
    
    // CO2 chart
    charts.co2 = new Chart(ctx2.getContext('2d'), {
        type: 'line',
        data: {
            labels: ['No Data'],
            datasets: [{
                label: 'COâ‚‚ Reduction',
                data: [0],
                borderColor: '#E5E7EB',
                backgroundColor: '#F9FAFB'
            }]
        },
        options: noDataMessage
    });
    
    // Material chart
    charts.materialDist = new Chart(ctx3.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['No Data'],
            datasets: [{
                data: [1],
                backgroundColor: ['#E5E7EB']
            }]
        },
        options: noDataMessage
    });
    
    // Update summary cards to show 0
    document.getElementById('analyticsAvgSavings').textContent = 'â‚¹0.00';
    document.getElementById('analyticsAvgCO2').textContent = '0.00';
    document.getElementById('analyticsThisMonth').textContent = '0';
    document.getElementById('analyticsBestSaving').textContent = 'â‚¹0.00';
    
    document.getElementById('costChartTotal').textContent = 'â‚¹0.00';
    document.getElementById('costChartBest').textContent = 'N/A';
    document.getElementById('co2ChartTotal').textContent = '0.00';
    document.getElementById('co2ChartBest').textContent = 'N/A';
    
    document.getElementById('pmCostThis').textContent = 'â‚¹0.00';
    document.getElementById('pmCO2This').textContent = '0.00';
    document.getElementById('pmRecsThis').textContent = '0';
}

function logout() {
    fetch('/api/logout', { 
        method: 'POST',
        credentials: 'include' 
    }).finally(() => {
        window.location.href = '/';
    });
}

let bulkResultsData = [];

function downloadBulkResults() {
    if (bulkResultsData.length === 0) {
        alert('No results to download');
        return;
    }
    
    const headers = [
        'Row', 
        'Material', 
        'Shape', 
        'Strength', 
        'Food Product Category',
        'Recycling',
        'Product Qty (g)', 
        'Package Weight (g)', 
        'Weight Capacity (g)',
        'Number of Units',
        'Recyclability (%)',
        'Predicted Cost (â‚¹)', 
        'Predicted COâ‚‚ Score', 
        'Status',
        'Error Message'
    ];
    
    const csvRows = [headers.join(',')];
    
    bulkResultsData.forEach(r => {
        const row = [
            r.row || '',
            (r.material || '').replace(/,/g, ';'),
            (r.shape || '').replace(/,/g, ';'),
            (r.strength || '').replace(/,/g, ';'),
            (r.food_group || '').replace(/,/g, ';'),
            (r.recycling || '').replace(/,/g, ';'),
            r.product_quantity || '',
            r.weight_measured || '',
            r.weight_capacity || '',
            r.number_of_units || '',
            r.recyclability_percent || '',
            r.cost || '',
            r.co2 || '',
            r.status || '',
            (r.error || '').replace(/,/g, ';').replace(/"/g, '""')
        ];
        csvRows.push(row.map(val => `"${val}"`).join(','));
    });
    
    const csvContent = '\uFEFF' + csvRows.join('\n'); // Add BOM for Excel compatibility
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ecopack_results_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

async function exportAnalyticsExcel() {
    try {
        // Fetch complete history data for export
        const res = await fetch(`${API}/history`, {
            credentials: 'include'
        });
        
        if (!res.ok) {
            alert('Failed to fetch data for export');
            return;
        }
        
        const data = await res.json();
        const historyData = data.history || [];
        
        if (historyData.length === 0) {
            alert('No data available to export');
            return;
        }
        
        console.log('=== Analytics Data Debug ===');
        console.log('Total history records:', historyData.length);
        if (historyData.length > 0) {
            console.log('Sample record structure:', historyData[0]);
            console.log('Sample material:', historyData[0].product?.material);
        }
        
        // Create professional Excel-ready CSV
        let csv = '\uFEFF'; // BOM for Excel compatibility
        
        // ============================================
        // HEADER SECTION
        // ============================================
        csv += 'EcoPackAI - Business Intelligence Analytics Report\n';
        csv += `Report Generated,${new Date().toLocaleString('en-IN', { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        })}\n`;
        csv += `Report ID,RPT-${Date.now()}\n`;
        csv += `Total Records,${historyData.length}\n`;
        csv += `Status,Active\n\n`;
        
        // ============================================
        // EXECUTIVE SUMMARY
        // ============================================
        const totalCostSavings = historyData.reduce((sum, item) => sum + (item.total_cost_savings || 0), 0);
        const totalCo2Reduction = historyData.reduce((sum, item) => sum + (item.total_co2_reduction || 0), 0);
        const avgCostSavings = historyData.length > 0 ? totalCostSavings / historyData.length : 0;
        const avgCo2Reduction = historyData.length > 0 ? totalCo2Reduction / historyData.length : 0;
        const optimalCount = historyData.filter(item => 
            (item.total_cost_savings || 0) >= 0 && (item.total_co2_reduction || 0) >= 0
        ).length;
        
        csv += 'EXECUTIVE SUMMARY\n';
        csv += 'Metric,Value\n';
        csv += `Total Recommendations,${historyData.length}\n`;
        csv += `Total Cost Savings (â‚¹),${totalCostSavings.toFixed(2)}\n`;
        csv += `Total COâ‚‚ Reduction,${totalCo2Reduction.toFixed(2)}\n`;
        csv += `Average Cost Savings per Recommendation (â‚¹),${avgCostSavings.toFixed(2)}\n`;
        csv += `Average COâ‚‚ Reduction per Recommendation,${avgCo2Reduction.toFixed(2)}\n`;
        csv += `Optimal Recommendations,${optimalCount}\n`;
        csv += `Success Rate (%),${historyData.length > 0 ? ((optimalCount / historyData.length) * 100).toFixed(1) : 0}\n`;
        csv += `Sustainability Score (%),95\n\n`;
        
        // ============================================
        // COMPLETE RECOMMENDATIONS DATA
        // ============================================
        csv += 'DETAILED RECOMMENDATIONS HISTORY\n';
        
        // Professional, clean headers (no "Input" prefix)
        csv += 'Record ID,Date & Time,';
        csv += 'Material,Shape,Strength,Food Category,Recycling Type,';
        csv += 'Product Quantity (g),Package Weight (g),Weight Capacity (g),Number of Units,Recyclability (%),';
        csv += 'Current Cost (â‚¹),Current COâ‚‚ Score,';
        csv += 'Recommended Material,Recommended Shape,Recommended Strength,';
        csv += 'Recommended Cost (â‚¹),Recommended COâ‚‚ Score,';
        csv += 'Cost Savings (â‚¹),COâ‚‚ Reduction,Improvement Score,Performance Status\n';
        
        // Helper function to handle N/A values
        const formatValue = (value, defaultValue = '') => {
            if (value === null || value === undefined || value === 'N/A' || value === '') {
                return defaultValue || '';
            }
            return value;
        };
        
        // Data rows
        historyData.forEach(item => {
            const date = new Date(item.created_at).toLocaleString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            const p = item.product;
            const c = item.current;
            const b = item.best_alternative;
            const costSavings = item.total_cost_savings || 0;
            const co2Reduction = item.total_co2_reduction || 0;
            const status = (costSavings >= 0 && co2Reduction >= 0) ? 'Optimal' : 'Review Required';
            
            // Input data - clean values
            csv += `REC-${item.id},"${date}",`;
            csv += `"${formatValue(p.material, 'Not Specified')}",`;
            csv += `"${formatValue(p.shape, 'Not Specified')}",`;
            csv += `"${formatValue(p.strength, 'Medium')}",`;
            csv += `"${formatValue(p.food_group, 'Not Specified')}",`;
            csv += `"${formatValue(p.recycling, 'Not Specified')}",`;
            csv += `${formatValue(p.product_quantity, '')},`;
            csv += `${formatValue(p.weight_measured, '')},`;
            csv += `${formatValue(p.weight_capacity, '')},`;
            csv += `${formatValue(p.number_of_units, 1)},`;
            csv += `${formatValue(p.recyclability_percent, '')},`;
            
            // Current packaging
            csv += `${c.cost.toFixed(2)},${c.co2.toFixed(2)},`;
            
            // Best alternative
            csv += `"${formatValue(b.material, 'Not Specified')}",`;
            csv += `"${formatValue(b.shape, 'Not Specified')}",`;
            csv += `"${formatValue(b.strength, 'Medium')}",`;
            csv += `${b.predicted_cost.toFixed(2)},${b.predicted_co2.toFixed(2)},`;
            
            // Impact metrics
            csv += `${costSavings.toFixed(2)},`;
            csv += `${co2Reduction.toFixed(2)},`;
            csv += `${formatValue(b.improvement_score ? b.improvement_score.toFixed(2) : '', '')},`;
            csv += `"${status}"\n`;
        });
        
        // ============================================
        // ALL ALTERNATIVES ANALYSIS
        // ============================================
        csv += '\n\nALL ALTERNATIVES DETAILED ANALYSIS\n';
        csv += 'Record ID,Rank,Material,Shape,Strength,Food Category,';
        csv += 'Package Weight (g),Weight Capacity (g),Recyclability (%),';
        csv += 'Predicted Cost (â‚¹),Predicted COâ‚‚ Score,Cost Savings (â‚¹),COâ‚‚ Reduction,Improvement Score\n';
        
        historyData.forEach(item => {
            item.all_recommendations.forEach((rec, idx) => {
                csv += `REC-${item.id},${idx + 1},`;
                csv += `"${formatValue(rec.material, 'Not Specified')}",`;
                csv += `"${formatValue(rec.shape, 'Not Specified')}",`;
                csv += `"${formatValue(rec.strength, 'Medium')}",`;
                csv += `"${formatValue(rec.food_group || item.product.food_group, 'Not Specified')}",`;
                csv += `${formatValue(rec.weight_measured || item.product.weight_measured, '')},`;
                csv += `${formatValue(rec.weight_capacity || item.product.weight_capacity, '')},`;
                csv += `${formatValue(rec.recyclability_percent || item.product.recyclability_percent, '')},`;
                csv += `${(rec.predicted_cost || 0).toFixed(2)},`;
                csv += `${(rec.predicted_co2 || 0).toFixed(2)},`;
                csv += `${(rec.cost_savings || 0).toFixed(2)},`;
                csv += `${(rec.co2_reduction || 0).toFixed(2)},`;
                csv += `${formatValue(rec.improvement_score ? rec.improvement_score.toFixed(2) : '', '')}\n`;
            });
        });
        
        // ============================================
        // PERFORMANCE METRICS
        // ============================================
        csv += '\n\nPERFORMANCE SCORECARD\n';
        csv += 'Metric,Current Value,Target,Status\n';
        csv += `Average Cost Savings (â‚¹),${avgCostSavings.toFixed(2)},250+,${avgCostSavings >= 250 ? 'On Track' : 'Below Target'}\n`;
        csv += `Average COâ‚‚ Reduction,${avgCo2Reduction.toFixed(2)},50+,${avgCo2Reduction >= 50 ? 'Excellent' : 'Good'}\n`;
        csv += `Total Recommendations,${historyData.length},10+ per month,Active\n`;
        csv += `Sustainability Score (%),95,90+,Achieved\n`;
        
        // ============================================
        // MATERIAL INSIGHTS
        // ============================================
        csv += '\n\nMATERIAL USAGE ANALYSIS\n';
        csv += 'Material,Frequency,Average Cost (â‚¹),Average COâ‚‚ Score\n';
        
        const materialStats = {};
        historyData.forEach(item => {
            const mat = formatValue(item.product.material, 'Not Specified');
            if (!materialStats[mat]) {
                materialStats[mat] = { count: 0, totalCost: 0, totalCo2: 0 };
            }
            materialStats[mat].count++;
            materialStats[mat].totalCost += item.current.cost;
            materialStats[mat].totalCo2 += item.current.co2;
        });
        
        Object.entries(materialStats)
            .sort((a, b) => b[1].count - a[1].count)
            .forEach(([material, stats]) => {
                csv += `"${material}",${stats.count},${(stats.totalCost / stats.count).toFixed(2)},${(stats.totalCo2 / stats.count).toFixed(2)}\n`;
            });
        
        // ============================================
        // RECOMMENDATIONS BREAKDOWN BY STATUS
        // ============================================
        csv += '\n\nRECOMMENDATIONS BY PERFORMANCE STATUS\n';
        csv += 'Status,Count,Percentage\n';
        csv += `Optimal,${optimalCount},${historyData.length > 0 ? ((optimalCount / historyData.length) * 100).toFixed(1) : 0}%\n`;
        csv += `Review Required,${historyData.length - optimalCount},${historyData.length > 0 ? (((historyData.length - optimalCount) / historyData.length) * 100).toFixed(1) : 0}%\n`;
        
        // ============================================
        // FOOTER
        // ============================================
        csv += '\n\nREPORT INFORMATION\n';
        csv += 'Generated By,EcoPackAI - Smart Packaging Intelligence Platform\n';
        csv += 'Platform,Business Analytics Dashboard\n';
        csv += `Export Timestamp,${new Date().toISOString()}\n`;
        csv += 'Data Accuracy,ML-Predicted Values\n';
        csv += 'Confidentiality,Business Intelligence Report\n';
        
        // Download file
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `EcoPackAI_Analytics_Report_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Success notification
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success position-fixed';
        alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: fadeIn 0.3s; min-width: 350px;';
        alertDiv.innerHTML = `
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-check-circle-fill" style="font-size: 1.5rem; color: #10b981;"></i>
                <div>
                    <strong>Export Successful!</strong>
                    <p class="mb-0 small">Complete analytics with ${historyData.length} records exported</p>
                </div>
            </div>
        `;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.style.animation = 'fadeOut 0.3s';
            setTimeout(() => alertDiv.remove(), 300);
        }, 4000);
        
    } catch (e) {
        console.error('Export error:', e);
        alert('Export failed: ' + e.message);
    }
} 

function exportAnalyticsPDF() {
    const printWindow = window.open('', '_blank');
    
    // Get current data
    const totalRecs = document.getElementById('totalRecs').textContent;
    const totalCost = document.getElementById('totalCost').textContent;
    const totalCO2 = document.getElementById('totalCO2').textContent;
    const avgSavings = document.getElementById('analyticsAvgSavings').textContent;
    const avgCO2 = document.getElementById('analyticsAvgCO2').textContent;
    const thisMonth = document.getElementById('analyticsThisMonth').textContent;
    const bestSaving = document.getElementById('analyticsBestSaving').textContent;
    
    // Get chart images (convert canvas to base64)
    const costChart = document.getElementById('costChart');
    const co2Chart = document.getElementById('co2Chart');
    const materialChart = document.getElementById('materialDistChart');
    
    const costChartImg = costChart ? costChart.toDataURL('image/png') : '';
    const co2ChartImg = co2Chart ? co2Chart.toDataURL('image/png') : '';
    const materialChartImg = materialChart ? materialChart.toDataURL('image/png') : '';
    
    // BUILD MATERIAL CHART SECTION WITH ENHANCED PROFESSIONAL LEGEND
    let materialChartSection = '';
    if (materialChart && charts.materialDist) {
        const chartData = charts.materialDist.data;
        const labels = chartData.labels || [];
        const values = chartData.datasets[0].data || [];
        const colors = chartData.datasets[0].backgroundColor || [];
        const total = values.reduce((a, b) => a + b, 0);
        
        // Build professional legend with visual bars
        let legendHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">';
        labels.forEach((label, i) => {
            const percentage = ((values[i] / total) * 100).toFixed(1);
            const count = values[i];
            legendHTML += `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid ${colors[i]};">
                    <div style="flex-shrink: 0; width: 20px; height: 20px; border-radius: 50%; background: ${colors[i]}; box-shadow: 0 2px 4px rgba(0,0,0,0.15);"></div>
                    <div style="flex-grow: 1;">
                        <div style="font-size: 9pt; font-weight: 700; color: #1f2937; margin-bottom: 2px;">${label}</div>
                        <div style="font-size: 8pt; color: #6b7280;">
                            <span style="font-weight: 600; color: ${colors[i]};">${percentage}%</span> 
                            <span style="color: #9ca3af;">â€¢ ${count} ${count === 1 ? 'rec' : 'recs'}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        legendHTML += '</div>';
        
        materialChartSection = `
            <div class="chart-container no-break" style="margin-top: 25px;">
                <div class="chart-title">Material Distribution Analysis</div>
                <div style="display: flex; justify-content: center; align-items: center; margin: 20px 0;">
                    <img src="${materialChartImg}" alt="Material Distribution Chart" style="max-width: 55%; height: auto;">
                </div>
                ${legendHTML}
                <div style="margin-top: 15px; padding: 12px; background: #eff6ff; border-radius: 6px; text-align: center; font-size: 9pt; color: #1e293b; border-left: 4px solid #0284c7;">
                    <strong>Analysis Summary:</strong> ${labels.length} material types tracked across ${total} total recommendations. 
                    Top material: <strong style="color: #0369a1;">${labels[0]}</strong> (${((values[0] / total) * 100).toFixed(1)}%)
                </div>
            </div>
        `;
    } else {
        materialChartSection = `
            <div class="chart-container no-break" style="margin-top: 25px;">
                <div class="chart-title">Material Distribution Analysis</div>
                <div style="padding: 60px; text-align: center; background: #f9fafb; border-radius: 8px; border: 2px dashed #d1d5db;">
                    <p style="color: #9ca3af; font-size: 10pt; margin: 0;">
                        <i style="font-size: 2rem; display: block; margin-bottom: 10px;">ðŸ“Š</i>
                        No material distribution data available
                    </p>
                </div>
            </div>
        `;
    }
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>EcoPackAI - Business Intelligence Analytics Report</title>
            <style>
                @page { 
                    size: A4; 
                    margin: 15mm; 
                }
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body { 
                    font-family: 'Segoe UI', 'Calibri', Arial, sans-serif;
                    font-size: 10pt;
                    line-height: 1.4;
                    color: #1f2937;
                    background: white;
                }
                
                /* HEADER - Professional corporate style */
                .report-header {
                    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                    color: white;
                    padding: 25px 30px;
                    border-radius: 8px;
                    margin-bottom: 25px;
                    position: relative;
                    overflow: hidden;
                }
                
                .report-header::after {
                    content: '';
                    position: absolute;
                    top: 0;
                    right: 0;
                    width: 200px;
                    height: 200px;
                    background: rgba(39, 174, 96, 0.1);
                    border-radius: 50%;
                    transform: translate(50%, -50%);
                }
                
                .report-header h1 {
                    font-size: 24pt;
                    margin: 0 0 8px 0;
                    font-weight: 700;
                    position: relative;
                    z-index: 1;
                }
                
                .report-header .meta {
                    font-size: 9pt;
                    opacity: 0.9;
                    position: relative;
                    z-index: 1;
                }
                
                .report-id {
                    display: inline-block;
                    background: rgba(255,255,255,0.15);
                    padding: 4px 12px;
                    border-radius: 4px;
                    font-weight: 600;
                    margin-left: 15px;
                }
                
                /* KPI GRID */
                .kpi-grid {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 12px;
                    margin: 25px 0;
                    page-break-inside: avoid;
                }
                
                .kpi-card {
                    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                    border: 2px solid #e5e7eb;
                    border-left: 4px solid #27AE60;
                    border-radius: 8px;
                    padding: 18px 15px;
                    text-align: center;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                    page-break-inside: avoid;
                }
                
                .kpi-card .label {
                    font-size: 8pt;
                    text-transform: uppercase;
                    color: #6b7280;
                    font-weight: 700;
                    margin-bottom: 8px;
                    letter-spacing: 0.8px;
                }
                
                .kpi-card .value {
                    font-size: 20pt;
                    font-weight: 700;
                    color: #1f2937;
                    line-height: 1.2;
                }
                
                .kpi-card .subtext {
                    font-size: 7pt;
                    color: #9ca3af;
                    margin-top: 4px;
                }
                
                /* SECTION TITLES */
                .section-title {
                    font-size: 14pt;
                    font-weight: 700;
                    color: #1e293b;
                    border-bottom: 3px solid #27AE60;
                    padding-bottom: 10px;
                    margin: 30px 0 20px 0;
                    page-break-after: avoid;
                }
                
                /* PERFORMANCE SCORECARD */
                .scorecard-table {
                    width: 100%;
                    border-collapse: separate;
                    border-spacing: 0;
                    margin: 20px 0;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    overflow: hidden;
                    page-break-inside: avoid;
                }
                
                .scorecard-table thead {
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                }
                
                .scorecard-table th {
                    padding: 12px;
                    text-align: left;
                    font-weight: 700;
                    font-size: 9pt;
                    color: #1e293b;
                    border-bottom: 2px solid #27AE60;
                }
                
                .scorecard-table td {
                    padding: 12px;
                    border-bottom: 1px solid #f3f4f6;
                    font-size: 9pt;
                }
                
                .scorecard-table tr:last-child td {
                    border-bottom: none;
                }
                
                .scorecard-table tr:hover {
                    background: #f9fafb;
                }
                
                .badge {
                    display: inline-block;
                    padding: 4px 10px;
                    border-radius: 4px;
                    font-size: 8pt;
                    font-weight: 700;
                    text-transform: uppercase;
                }
                
                .badge-success { background: #D1FAE5; color: #065F46; }
                .badge-primary { background: #DBEAFE; color: #0369A1; }
                .badge-warning { background: #FEF3C7; color: #92400E; }
                .badge-excellent { background: #D1FAE5; color: #065F46; }
                
                /* INSIGHTS BOX */
                .insights-box {
                    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                    border-left: 4px solid #0284c7;
                    padding: 20px;
                    border-radius: 6px;
                    margin: 20px 0;
                    page-break-inside: avoid;
                }
                
                .insights-box h4 {
                    font-size: 12pt;
                    font-weight: 700;
                    margin: 0 0 15px 0;
                    color: #1e293b;
                }
                
                .insights-box ul {
                    margin: 0;
                    padding-left: 20px;
                    line-height: 1.8;
                }
                
                .insights-box li {
                    margin-bottom: 10px;
                    font-size: 9pt;
                }
                
                .insights-box strong {
                    color: #0369a1;
                }
                
                /* CHARTS SECTION */
                .charts-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 20px;
                    margin: 25px 0;
                    page-break-inside: avoid;
                }
                
                .chart-container {
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 15px;
                    text-align: center;
                    page-break-inside: avoid;
                }
                
                .chart-title {
                    font-size: 11pt;
                    font-weight: 700;
                    color: #1e293b;
                    margin-bottom: 12px;
                    text-align: left;
                }
                
                .chart-container img {
                    max-width: 100%;
                    height: auto;
                    border-radius: 4px;
                }
                
                /* FOOTER - Fixed to flowing layout */
                .report-footer {
                    margin-top: 40px;
                    padding: 20px 0;
                    border-top: 2px solid #e5e7eb;
                    text-align: center;
                    font-size: 8pt;
                    color: #6b7280;
                    page-break-inside: avoid;
                }
                
                .report-footer .logo {
                    font-size: 11pt;
                    font-weight: 700;
                    color: #27AE60;
                    margin-bottom: 4px;
                }
                
                .report-footer p {
                    margin: 2px 0;
                }
                
                /* PAGE BREAK CONTROLS */
                .page-break {
                    page-break-after: always;
                }
                
                .no-break {
                    page-break-inside: avoid;
                }
                
                @media print {
                    body { 
                        print-color-adjust: exact; 
                        -webkit-print-color-adjust: exact; 
                    }
                }
            </style>
        </head>
        <body>
            <!-- PAGE 1 -->
            <div class="report-header">
                <h1>EcoPackAI Analytics Report</h1>
                <div class="meta">
                    Generated: ${new Date().toLocaleString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })} 
                    <span class="report-id">Report ID: RPT-${Date.now()}</span>
                    | Status: <strong>Active</strong>
                </div>
            </div>

            <!-- EXECUTIVE SUMMARY -->
            <div class="kpi-grid no-break">
                <div class="kpi-card">
                    <div class="label">Average Savings</div>
                    <div class="value">${avgSavings}</div>
                    <div class="subtext">Per recommendation</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Average COâ‚‚ Reduction</div>
                    <div class="value">${avgCO2}</div>
                    <div class="subtext">Environmental impact</div>
                </div>
                <div class="kpi-card">
                    <div class="label">This Month</div>
                    <div class="value">${thisMonth}</div>
                    <div class="subtext">Active recommendations</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Peak Savings</div>
                    <div class="value">${bestSaving}</div>
                    <div class="subtext">Best performance</div>
                </div>
            </div>

            <!-- PERFORMANCE SCORECARD -->
            <div class="section-title">Performance Scorecard</div>

            <table class="scorecard-table no-break">
                <thead>
                    <tr>
                        <th style="width: 35%;">Metric</th>
                        <th style="width: 20%;">Current Value</th>
                        <th style="width: 20%;">Target</th>
                        <th style="width: 25%;">Performance Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Average Cost Savings</strong></td>
                        <td><strong>${avgSavings}</strong></td>
                        <td>â‚¹250+</td>
                        <td><span class="badge badge-success">On Track</span></td>
                    </tr>
                    <tr>
                        <td><strong>Average COâ‚‚ Reduction</strong></td>
                        <td><strong>${avgCO2}</strong></td>
                        <td>50+ units</td>
                        <td><span class="badge badge-excellent">Excellent</span></td>
                    </tr>
                    <tr>
                        <td><strong>Total Recommendations</strong></td>
                        <td><strong>${totalRecs}</strong></td>
                        <td>10+/month</td>
                        <td><span class="badge badge-primary">Active</span></td>
                    </tr>
                    <tr>
                        <td><strong>Sustainability Score</strong></td>
                        <td><strong>95%</strong></td>
                        <td>90%+</td>
                        <td><span class="badge badge-success">Achieved</span></td>
                    </tr>
                </tbody>
            </table>

            <!-- KEY INSIGHTS -->
            <div class="insights-box no-break">
                <h4>Key Business Insights</h4>
                <ul>
                    <li><strong>Financial Optimization:</strong> Average savings of ${avgSavings} demonstrates strong cost efficiency in packaging material selection, with potential annual savings of â‚¹${(parseFloat(avgSavings.replace('â‚¹', '')) * 12).toFixed(2)} at current adoption rates.</li>
                    <li><strong>Environmental Impact:</strong> Total COâ‚‚ reduction of ${totalCO2} contributes significantly to corporate sustainability goals and carbon neutrality targets, equivalent to removing approximately ${(parseFloat(totalCO2.replace(/[^0-9.]/g, '')) / 20).toFixed(1)} vehicles from roads annually.</li>
                    <li><strong>Platform Utilization:</strong> ${thisMonth} recommendations this month indicates strong user engagement and growing adoption across business units.</li>
                    <li><strong>Best Practice Achievement:</strong> Peak savings of ${bestSaving} demonstrates optimization potential and provides a benchmark for future recommendations.</li>
                    <li><strong>Trend Analysis:</strong> Consistent improvement in both cost and environmental metrics suggests effective AI model performance and user adoption of sustainable alternatives.</li>
                </ul>
            </div>

            <!-- PAGE BREAK -->
            <div class="page-break"></div>

            <!-- PAGE 2 - VISUAL ANALYTICS -->
            <div class="section-title">Visual Analytics and Performance Trends</div>

            <div class="charts-grid no-break">
                <div class="chart-container">
                    <div class="chart-title">Cost Savings Trend Analysis</div>
                    ${costChartImg ? `<img src="${costChartImg}" alt="Cost Savings Chart">` : '<p style="color: #9ca3af; padding: 40px;">Chart data not available</p>'}
                    <div style="margin-top: 10px; font-size: 8pt; color: #6b7280;">
                        <strong>Total Saved:</strong> ${totalCost}
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">COâ‚‚ Reduction Trend Analysis</div>
                    ${co2ChartImg ? `<img src="${co2ChartImg}" alt="CO2 Reduction Chart">` : '<p style="color: #9ca3af; padding: 40px;">Chart data not available</p>'}
                    <div style="margin-top: 10px; font-size: 8pt; color: #6b7280;">
                        <strong>Total Reduced:</strong> ${totalCO2}
                    </div>
                </div>
            </div>

            ${materialChartSection}

            <!-- STRATEGIC RECOMMENDATIONS -->
            <div class="section-title">Strategic Recommendations</div>
            <div class="insights-box no-break">
                <ul>
                    <li><strong>Scale Implementation:</strong> Expand AI-powered recommendations across all product lines to maximize both cost savings and environmental benefits.</li>
                    <li><strong>Supplier Partnerships:</strong> Engage with top-performing eco-friendly material suppliers to secure volume discounts and ensure supply chain stability.</li>
                    <li><strong>Training and Adoption:</strong> Conduct training sessions for procurement teams to increase platform adoption and optimize material selection decisions.</li>
                    <li><strong>Continuous Monitoring:</strong> Establish quarterly reviews to track progress against sustainability KPIs and adjust targets accordingly.</li>
                    <li><strong>Industry Benchmarking:</strong> Compare performance metrics with industry standards to identify additional optimization opportunities.</li>
                </ul>
            </div>

            <!-- FOOTER -->
            <div class="report-footer">
                <div style="margin-bottom: 8px;">
                    <span class="logo">EcoPackAI</span>
                </div>
                <p style="margin: 4px 0;"><strong>Intelligent Sustainable Packaging Solutions</strong></p>
                <p style="margin: 8px 0 0 0; font-size: 7pt; color: #9ca3af;">
                    Â© 2025 EcoPackAI. Confidential Business Intelligence Report. | Generated: ${new Date().toLocaleDateString('en-IN')}
                </p>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Wait for images to load before printing
    setTimeout(() => {
        printWindow.print();
    }, 800);
}

// ============================================================================
// AI CHATBOT FUNCTIONALITY
// ============================================================================

let chatbotOpen = false;
let chatHistory = [];

function toggleChatbot() {
    const bubble = document.getElementById('chat-bubble');
    const chatWindow = document.getElementById('chat-window');
    const badge = document.getElementById('chat-badge');
    
    console.log('Toggle clicked!'); // Debug log
    
    // Check ACTUAL visibility (not just class)
    const isCurrentlyOpen = chatWindow.offsetHeight > 0 && chatWindow.offsetWidth > 0;
    
    console.log('Currently open:', isCurrentlyOpen); // Debug log
    
    if (isCurrentlyOpen) {
        // CLOSE
        chatWindow.classList.add('hidden');
        chatWindow.style.display = 'none'; // Force hide
        bubble.classList.remove('hidden');
        bubble.style.display = 'flex'; // Force show
        chatbotOpen = false;
        console.log('Chatbot closed');
    } else {
        // OPEN
        chatWindow.classList.remove('hidden');
        chatWindow.style.display = 'flex'; // Force show
        bubble.classList.add('hidden');
        bubble.style.display = 'none'; // Force hide
        chatbotOpen = true;
        console.log('Chatbot opened');
        
        if (badge) badge.style.display = 'none';
        
        // Focus input
        setTimeout(() => {
            const input = document.getElementById('chat-input');
            if (input) input.focus();
        }, 300);
    }
}

function handleChatKeypress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendQuickAction(message) {
    const input = document.getElementById('chat-input');
    input.value = message;
    sendMessage();
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage(message, 'user');
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
        // Call AI comparison API
        const response = await fetch(`${API}/analytics/compare`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: message + " (Keep response under 4 sentences, no tables)"
            })
        });
        
        if (handleAuthError(response)) {
            removeTypingIndicator();
            return;
        }
        
        const data = await response.json();
        
        removeTypingIndicator();
        
        if (response.ok && data.response) {
            // Truncate long responses
            const response = truncateResponse(data.response, 500); // Reduced from 600
            addMessage(response, 'bot', true);
            
            // Store in history
            chatHistory.push({
                user: message,
                bot: data.response,
                timestamp: new Date().toISOString()
            });
        } else {
            addMessage(data.error || 'Sorry, I encountered an error. Please try again.', 'bot', false, true);
        }
        
    } catch (error) {
        console.error('Chat error:', error);
        removeTypingIndicator();
        addMessage('âš ï¸ Network error. Please check your connection and try again.', 'bot', false, true);
    }
}

function addMessage(text, sender = 'bot', isMarkdown = false, isError = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';
    avatarDiv.innerHTML = sender === 'bot' ? '<i class="bi bi-robot"></i>' : '<i class="bi bi-person-fill"></i>';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = `message-content ${isError ? 'error-message' : ''}`;
    
    if (sender === 'bot') {
        const nameStrong = document.createElement('strong');
        nameStrong.textContent = 'EcoBot';
        contentDiv.appendChild(nameStrong);
    }
    
    if (isMarkdown && sender === 'bot') {
        // Simple markdown rendering
        const formattedText = formatMarkdown(text);
        const textDiv = document.createElement('div');
        textDiv.innerHTML = formattedText;
        contentDiv.appendChild(textDiv);
    } else {
        const textP = document.createElement('p');
        textP.textContent = text;
        contentDiv.appendChild(textP);
    }
    
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);
    messagesContainer.appendChild(messageDiv);
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function truncateResponse(text, maxLength = 500) {
    if (text.length <= maxLength) return text;
    
    // Cut at last sentence before limit
    const truncated = text.substring(0, maxLength);
    const lastPeriod = truncated.lastIndexOf('.');
    
    if (lastPeriod > 100) {
        return truncated.substring(0, lastPeriod + 1);
    }
    
    // Emergency fallback
    return truncated.substring(0, 450) + '...';
}

function formatMarkdown(text) {
    let html = text;
    
    // Remove any markdown tables completely (they don't work in chat)
    html = html.replace(/\|.*\|/g, '');
    html = html.replace(/[-:]+\|[-:| ]+/g, '');
    
    // Headers (smaller sizes for chat)
    html = html.replace(/^### (.*$)/gim, '<div style="font-weight: 700; margin: 0.5rem 0; font-size: 0.95rem; color: var(--asparagus);">$1</div>');
    html = html.replace(/^## (.*$)/gim, '<div style="font-weight: 700; margin: 0.5rem 0; font-size: 1rem; color: var(--asparagus);">$1</div>');
    html = html.replace(/^# (.*$)/gim, '<div style="font-weight: 700; margin: 0.5rem 0; font-size: 1.05rem; color: var(--asparagus);">$1</div>');
    
    // Bold
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--charcoal);">$1</strong>');
    
    // Italic
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Bullet points (â€¢ format)
    html = html.replace(/^[â€¢\-\*] (.*$)/gim, '<li style="margin-bottom: 0.25rem;">$1</li>');
    
    // Wrap consecutive <li> in <ul>
    html = html.replace(/((?:<li[^>]*>.*?<\/li>\s*)+)/gi, '<ul style="margin: 0.5rem 0; padding-left: 1.2rem; list-style: disc;">$1</ul>');
    
    // Line breaks
    html = html.replace(/\n\n/g, '<br><br>');
    html = html.replace(/\n/g, '<br>');
    
    return html;
}

function showTypingIndicator() {
    const messagesContainer = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message';
    typingDiv.id = 'typing-indicator-msg';
    
    typingDiv.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-robot"></i>
        </div>
        <div class="message-content">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typing-indicator-msg');
    if (indicator) {
        indicator.remove();
    }
}

function clearChat() {
    const messagesContainer = document.getElementById('chat-messages');
    
    // Keep only the welcome message
    const welcomeMessage = messagesContainer.querySelector('.message');
    messagesContainer.innerHTML = '';
    
    if (welcomeMessage) {
        messagesContainer.appendChild(welcomeMessage.cloneNode(true));
    }
    
    chatHistory = [];
    
    // Show confirmation
    addMessage('Chat cleared! How can I help you today?', 'bot');
}

// Initialize chatbot badge animation
document.addEventListener('DOMContentLoaded', () => {
    // Hide badge after 3 seconds
    setTimeout(() => {
        const badge = document.getElementById('chat-badge');
        if (badge && !chatbotOpen) {
            badge.style.animation = 'fadeOut 0.5s';
            setTimeout(() => {
                badge.style.display = 'none';
            }, 500);
        }
    }, 3000);
});

    </script>
    <!-- AI CHATBOT -->
<div id="chatbot-container">
    <!-- Chat Bubble (Collapsed State) -->
    <div id="chat-bubble" onclick="toggleChatbot()">
        <i class="bi bi-chat-dots-fill"></i>
        <span class="chat-badge" id="chat-badge">1</span>
    </div>
    
    <!-- Chat Window (Expanded State) -->
    <div id="chat-window" class="hidden">
        <div class="chat-header">
            <div class="d-flex align-items-center gap-2">
                <div style="width: 35px; height: 35px; background: linear-gradient(135deg, var(--asparagus) 0%, #229954 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-robot" style="color: white; font-size: 1.2rem;"></i>
                </div>
                <div>
                    <strong style="font-size: 0.95rem;">EcoBot Assistant</strong>
                    <div style="font-size: 0.7rem; opacity: 0.8;">
                        <i class="bi bi-circle-fill" style="color: #10b981; font-size: 0.5rem;"></i> Online
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="chat-control-btn" onclick="clearChat()" title="Clear chat">
                    <i class="bi bi-trash"></i>
                </button>
                <button class="chat-control-btn" onclick="toggleChatbot()" title="Minimize">
                    <i class="bi bi-dash-lg"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <!-- Welcome message -->
            <div class="message bot-message">
                <div class="message-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="message-content">
                    <strong>EcoBot</strong>
                    <p>ðŸ‘‹ Hi! I'm your EcoPackAI assistant. I can help you with:</p>
                    <ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem; font-size: 0.85rem;">
                        <li>Analyzing your packaging recommendations</li>
                        <li>Comparing cost & environmental impact</li>
                        <li>Material selection advice</li>
                        <li>Sustainability insights</li>
                    </ul>
                    <p style="margin-top: 0.5rem; font-size: 0.85rem;">Try: <em>"Compare my last 2 recommendations"</em></p>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-quick-actions">
                <button class="quick-action-btn" onclick="sendQuickAction('Compare last 2 recommendations')">
                    <i class="bi bi-arrow-left-right"></i> Compare
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('Show cost savings trends')">
                    <i class="bi bi-graph-up"></i> Trends
                </button>
                <button class="quick-action-btn" onclick="sendQuickAction('Best material for sustainability')">
                    <i class="bi bi-leaf"></i> Best Material
                </button>
            </div>
            <div class="chat-input-wrapper">
                <input 
                    type="text" 
                    id="chat-input" 
                    placeholder="Ask me anything about your packaging..."
                    onkeypress="handleChatKeypress(event)"
                />
                <button id="chat-send-btn" onclick="sendMessage()">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>

</body> 
</html>
