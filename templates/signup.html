{% extends "base.html" %}

{% block title %}Sign Up - EcoPackAI{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card border-0 shadow-lg my-5">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div class="mb-4">
                            <i class="fas fa-leaf fa-3x text-success"></i>
                        </div>
                        <h2 class="fw-bold mb-2">Create Account</h2>
                        <p class="text-muted">
                            Join EcoPackAI and start your sustainable packaging journey
                        </p>
                    </div>

                    <div id="alertContainer"></div>

                    <form id="signupForm" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user me-1"></i>Username *
                                </label>
                                <input type="text" class="form-control" id="username"
                                       placeholder="Choose a username"
                                       minlength="3" required>
                                <div class="invalid-feedback">
                                    Username must be at least 3 characters.
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email *
                                </label>
                                <input type="email" class="form-control" id="email"
                                       placeholder="your@email.com" required>
                                <div class="invalid-feedback">
                                    Enter a valid email address.
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-lock me-1"></i>Password *
                                </label>
                                <input type="password" class="form-control" id="password"
                                       placeholder="Minimum 8 characters"
                                       minlength="8" required>
                                <div class="invalid-feedback">
                                    Password must be at least 8 characters.
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fas fa-lock me-1"></i>Confirm Password *
                                </label>
                                <input type="password" class="form-control" id="confirmPassword"
                                       placeholder="Re-enter your password" required>
                                <div class="invalid-feedback">
                                    Passwords do not match.
                                </div>
                            </div>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="terms" required>
                            <label class="form-check-label small">
                                I agree to the
                                <a href="#" class="text-success text-decoration-none">Terms</a> and
                                <a href="#" class="text-success text-decoration-none">Privacy Policy</a>
                            </label>
                        </div>

                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-success btn-lg" id="signupBtn">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </div>

                        <div class="text-center">
                            <p class="text-muted mb-0">
                                Already have an account?
                                <a href="/login" class="fw-bold text-success text-decoration-none">
                                    Sign In
                                </a>
                            </p>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
const form = document.getElementById("signupForm");
const btn = document.getElementById("signupBtn");
const alertContainer = document.getElementById("alertContainer");

const usernameEl = document.getElementById("username");
const emailEl = document.getElementById("email");
const passwordEl = document.getElementById("password");
const confirmPasswordEl = document.getElementById("confirmPassword");

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearAlerts();

    if (passwordEl.value !== confirmPasswordEl.value) {
        confirmPasswordEl.classList.add("is-invalid");
        showAlert("danger", "Passwords do not match");
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';

    try {
        const res = await fetch("/api/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: usernameEl.value.trim(),
                email: emailEl.value.trim(),
                password: passwordEl.value
            })
        });

        const data = await res.json();

        if (res.ok) {
            showAlert("success", "Account created successfully! Redirecting...");
            setTimeout(() => window.location.href = "/login", 1500);
        } else {
            showAlert("danger", data.error || data.message || "Registration failed");
        }
    } catch {
        showAlert("danger", "Network error. Please try again.");
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-user-plus me-2"></i>Create Account';
    }
});

confirmPasswordEl.addEventListener("input", () => {
    confirmPasswordEl.classList.toggle(
        "is-invalid",
        passwordEl.value && confirmPasswordEl.value !== passwordEl.value
    );
});

function showAlert(type, msg) {
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show">
            ${msg}
            <button class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function clearAlerts() {
    alertContainer.innerHTML = "";
}
</script>
{% endblock %}
